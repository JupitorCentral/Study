## PostgreSQL íŒŒì¼ êµ¬ì¡°

- Heap Table -> ê·¸ëƒ¥ table ì´ë¼ê³  í•˜ì§€ ì•Šê³  heap table ì´ë¼ê³  í•œë‹¤.

ë”ë¯¸ (heap) ì²˜ëŸ¼ ìŒ“ì—¬ì„œ Heap table ì´ë¼ê³  ë¶ˆë¦°ë‹¤.

![[Screenshot 2025-12-15 at 12.24.34 AM.png]]


í…Œì´ë¸” íŒŒì¼ ì•ˆì—ëŠ” í˜ì´ì§€ë“¤ì´ ìˆìœ¼ë©°, ê° í˜ì´ì§€ ë§ˆë‹¤ í˜ì´ì§€ í—¤ë”ë“¤ì´ ìˆë‹¤.
ê·¸ë¦¬ê³  ê·¸ í˜ì´ì§€ ì•ˆì— íŠœí”Œ - ì¦‰ ë ˆì½”ë“œë“¤ì´ ìˆë‹¤.


ë¹ˆ ê³µê°„ - line pointers ë°°ì—´ì˜ ë§ˆì§€ë§‰ê³¼ ê°€ì¥ ìµœê·¼ì— ìƒì„±ëœ tuple ì˜ ì‹œì‘ë¶€ë¶„ ì‚¬ì´ë¥¼ free space ë˜ëŠ” hole ì´ë¼ê³  í‘œí˜„í•¨.
í…Œì´ë¸”ì— ìˆëŠ” tuple ì„ identify í•˜ê¸° ìœ„í•´, tuple identifier (tid) ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©ë¨.
tid ëŠ” 2ê°€ì§€ ê°’ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆëŠ”ë°, tuple ì„ ê°€ì§€ê³  ìˆëŠ” block ê³¼ ê·¸ offset ìœ¼ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŒ.

### heap tuple

ì—¬ê¸°ì„œë„ ë ˆì½”ë“œë“¤ì„ ê·¸ëƒ¥ ë ˆì½”ë“œë¼ê³  í•˜ì§€ ì•Šê³  heap tuple ì´ë¼ê³  í•œë‹¤.
Heap tuple ì€ í˜ì´ì§€ì˜ í•˜ë‹¨ë¶€í„° ìŒ“ì¸ë‹¤.

### line pointer 

4 byte ê¸¸ì´ë¥¼ ê°€ì§€ê³  ìˆê³ , í•˜ë‚˜ì˜ heap tuple ì„ ê°€ë¦¬í‚¨ë‹¤. item pointer ë¼ê³ ë„ ë¶ˆë¦°ë‹¤.
ë¼ì¸ í¬ì¸í„°ë“¤ì€ tuple ë“¤ì— ëŒ€í•œ ì¸ë±ìŠ¤ ì—­í• ì„ í•˜ëŠ” ê°„ë‹¨í•œ ë°°ì—´ì„ ì´ë£¬ë‹¤.
ìƒˆë¡œìš´ ë¼ì¸í¬ì¸í„°ëŠ” ì´ ë°°ì—´ì— push ë¨.

### header Data

PageHeaderData êµ¬ì¡°ì— ì˜í•´ ì •ì˜ë˜ëŠ” header Data ëŠ” í˜ì´ì§€ì˜ ì‹œì‘ë¶€ë¶„ì— ìœ„ì¹˜í•˜ê³  ìˆë‹¤.
24 ë°”ì´íŠ¸ì´ê³  í˜ì´ì§€ì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì •ë³´ë“¤ì„ ë‹´ê³  ìˆìŒ.

#### ì£¼ìš” í—¤ë”ë“¤

- pd_lsn
ì´ í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ ë³€ë™ì‚¬í•­ì— ì˜í•´ ì“°ì—¬ì§€ëŠ” XLOG record ì˜ LSN ê°’ì„ ê°€ì§€ê³  ìˆìŒ
8 byte unsinged integer ì´ê³  WAL (Write-Ahead Logging) ë©”ì¹´ë‹ˆì¦˜ê³¼ ì—°ê²°ë˜ì–´ ìˆìŒ.


- pd_checksum
í˜ì´ì§€ì˜ checksum ì„ ë‹´ëŠ”ë‹¤.

- pd_lower, pd_upper
pd_lower ëŠ” line pointers ì˜ ë ë¶€ë¶„ì„, pd_upper ëŠ” ê°€ì¥ ìµœê·¼ì˜ heap tuple ì˜ ì‹œì‘ì ì„ ê°€ë¦¬í‚¨ë‹¤.

- pd_special
ì¸ë±ìŠ¤ë¥¼ ìœ„í•œ í—¤ë”ì´ë‹¤. ì´ í˜ì´ì§€ê°€ ì†í•œ í…Œì´ë¸”ì— ëŒ€í•´ì„œ, page ì˜ ëì„ ê°€ë¦¬í‚¨ë‹¤. 




### Tuple structure


![[Screenshot 2025-12-15 at 12.29.06 AM.png]]

heap tuple ì˜ êµ¬ì¡°ì´ë‹¤.
ë°ì´í„°ê°€ ìˆê³ , í˜ì´ì§€ì™€ ë§ˆì°¬ê°€ì§€ë¡œ í—¤ë”ê°€ ìˆë‹¤.

- t_xmin : tuple ì„ insert í•œ íŠ¸ëœì­ì…˜ì˜ txid 
- t_max : tuple ì„ delete í•˜ê±°ë‚˜ update í•œ íŠ¸ëœì­ì…˜ì˜ txid
  ë§Œì•½ delete ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê°’ì´ 0 ì„ (invalid)
- t_cid : 0ë¶€í„° ì‹œì‘í•´ì„œ, í˜„ì¬ íŠ¸ëœì­ì…˜ì—ì„œ ì´ tuple ì´ insert ëœ statement ì˜ ìˆœì„œ.
  ì˜ˆë¥¼ë“¤ì–´ transaction a (begin; insert; insert; commit;) ì¼ë•Œ ì²«ë²ˆì§¸ insert ë•Œ ë“¤ì–´ê°”ë‹¤ë©´ 0, ë‘ë²ˆì§¸ insert ë•Œ ë“¤ì–´ê°”ë‹¤ë©´ 1ì´ë‹¤.
- t_ctid : tuple ê·¸ ìì‹  ë˜ëŠ” ë‹¤ë¥¸ ìƒˆë¡œìš´ tuple ì— ëŒ€í•œ tid (tuple identifier) ë¥¼ ê°€ì§€ê³  ìˆìŒ.
  ë§Œì•½ tuple ì´ ì—…ë°ì´íŠ¸ ë˜ë©´, t_ctid ëŠ” ìƒˆë¡œìš´ íŠœí”Œì„ ê°€ë¦¬í‚´. ì—…ë°ì´íŠ¸ ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìŠ¤ìŠ¤ë¡œë¥¼ ê°€ë¦¬í‚´.



## postgreSQL ì—ì„œ shared lock, exclusive lock ì„ ì“°ëŠ” ì¿¼ë¦¬

- shared lock

```sql
BEGIN WORK;
LOCK TABLE films IN SHARE MODE;
SELECT id FROM films
    WHERE name = 'Kpop demon hunters';
-- Do ROLLBACK if record was not returned
INSERT INTO films_user_comments VALUES
    (_id_, 'GREAT! I was waiting for it for so long!');
COMMIT WORK;
```

- exclude lock

```sql
BEGIN WORK;
LOCK TABLE films IN SHARE ROW EXCLUSIVE MODE;
DELETE FROM films_user_comments WHERE id IN
    (SELECT id FROM films WHERE rating < 5);
DELETE FROM films WHERE rating < 5;
COMMIT WORK;
```

ê·¸ë¦¬ê³  ì´ëŸ°ì‹ìœ¼ë¡œ postgresql ì˜ ëª¨ë“  í…Œì´ë¸” ë½ ìœ í˜•ì— ëŒ€í•´ ì“¸ ìˆ˜ê°€ ìˆëŠ”ë°...

ê·¼ë° intension lock ì€ ëª…ì‹œì ìœ¼ë¡œ ì¿¼ë¦¬ë¡œ ê±¸ ìˆ˜ê°€ ì—†ë‹¤.

ëŒ€ì‹  ë‹¤ë¥¸ ëª¨ë“œê°€ ì´ë¥¼ ëŒ€ì‹ í•œë‹¤

```sql
-- Intention Shared (IS) ì²˜ëŸ¼ ì“°ê³  ì‹¶ì„ ë•Œ
LOCK TABLE films IN ROW SHARE MODE;

-- Intention Exclusive (IX) ì²˜ëŸ¼ ì“°ê³  ì‹¶ì„ ë•Œ
LOCK TABLE films IN ROW EXCLUSIVE MODE;
```

ê·¼ë° ì—¬ê¸°ì„œ ì ê¹. postgreSQL ì—ì„œ lock ì˜ ê°œë…ì„ ì´í•´í•˜ë ¤ë©´ MVCC ì˜ ëŒ€ì „ì œë¥¼ ê¹”ê³  ê°€ì•¼í•œë‹¤.




ì½ëŠ” íŠ¸ëœì­ì…˜ê³¼ ì“°ëŠ” íŠ¸ëœì­ì…˜ì„ ì„œë¡œ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ”ë‹¤ê°€ MVCC ì˜ ì»¨ì…‰ì´ë‹¤.
ì´ê²Œ ê°€ëŠ¥í•œ ì´ìœ ëŠ” ë°ì´í„°ë¥¼ ë®ì–´ì“°ì§€ ì•Šê³  ìƒˆë¡œìš´ ë²„ì „ì„ ë§Œë“¤ê¸° ë•Œë¬¸ì´ë‹¤.


## Concurrency Control technique in PostgreSQL

Concurrency Control ì€ ì—¬ëŸ¬ê°œì˜ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ì‹¤í–‰ë ë•Œ, Atomicity ì™€ isolation ì„ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ë§í•œë‹¤.

3ê°€ì§€ ë„ë¦¬ì“°ì´ëŠ” í…Œí¬ë‹‰ì´ ìˆëŠ”ë°, MVCC, S2PL, OCC ì´ ê·¸ê²ƒì´ë‹¤. ê° í…Œí¬ë‹‰ì€ ì—¬ëŸ¬ê°€ì§€ variation ë“¤ì´ ìˆë‹¤.

- MVCC : Multi-version Concurrency Control
- S2PL : Strict Two-Phase Locking
- OCC : Optimistic Concurrency Control 

MVCC ì—ì„œëŠ”, ë°ì´í„°ë§ˆë‹¤ ë²„ì „ì´ë¼ëŠ” ê²ƒì´ ìˆê³  ì“°ê¸° ë™ì‘ì´ ê¸°ì¡´ì˜ ê°’ì„ ë®ì–´ì“°ëŠ”ê²ƒì´ ì•„ë‹ˆë¼, ê·¸ ì´ì „ë²„ì „ì˜ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë©´ì„œ
ìƒˆë¡œìš´ ë²„ì „ì˜ ì•„ì´í…œì„ ìƒì„±í•˜ëŠ” ê²ƒì´ë‹¤. íŠ¸ëœì­ì…˜ì´ ë°ì´í„°ë¥¼ ì½ì„ë•Œ ì‹œìŠ¤í…œì´ ê·¸ ë²„ì „ë“¤ ì¤‘ í•˜ë‚˜ì˜ ë°ì´í„°ë¥¼ ì„ íƒí•´ì„œ ë³´ì—¬ì£¼ê¸° ë•Œë¬¸ì— 
ê°ê°ì˜ íŠ¸ëœì­ì…˜ ì‚¬ì´ì˜ isolation ì„ ë³´ì¥í•  ìˆ˜ ìˆë‹¤.

MVCC ì˜ ì¥ì ì€ 'reader' ê°€ 'writer' ë¥¼ block í•˜ì§€ ì•Šê³ , 'writer' ê°€ 'reader' ë¥¼ block í•˜ì§€ ì•ŠëŠ” ê²ƒì´ë‹¤.
ë°˜ëŒ€ë¡œ, ì˜ˆë¥¼ ë“¤ì–´, S2PL-based ì‹œìŠ¤í…œì€ writer ê°€ ë°ì´í„°ë¥¼ ì“¸ë•Œ ë°˜ë“œì‹œ reader ë¥¼ block í•´ì•¼ í•˜ëŠ”ë° 
ì´ëŠ” writer ê°€ í•´ë‹¹ ì•„ì´í…œì— ëŒ€í•´ exclusive lock ì„ ì–»ê¸° ë•Œë¬¸ì´ë‹¤.
PostgreSQL ì™€ ëª‡ëª‡ rdbms ëŠ” Snapshot Isolation (SI) ë¼ëŠ” MVCC ì˜ variation ì„ ì‚¬ìš©í•œë‹¤.

SI ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ , oracle ê°™ì€ rdbms ëŠ” rollback segment ë¥¼ ì‚¬ìš©í•œë‹¤.

- rollback segment
-> ê·¸ëƒ¥ ì´ì „ë²„ì „ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê³µê°„ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì“¸ë•Œ, ì´ì „ ë²„ì „ì˜ ë°ì´í„°ê°€ rollback segment ì— ì“°ì´ê³ , ê·¸ ë‹¤ìŒì— ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì´ì „ ë²„ì „ì˜ ë°ì´í„°ê°€ ìˆëŠ” ì¥ì†Œì— ë®ì–´ì”Œì›Œì§„ë‹¤. 
postgresql ì€ ë” ê°„ë‹¨í•œ ë²„ì „ì„ ì“°ëŠ”ë°, 
ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì§ì ‘ì ìœ¼ë¡œ ì—°ê´€ëœ í…Œì´ë¸”ì˜ í˜ì´ì§€ì— ë°”ë¡œ ìŒ“ì¸ë‹¤. (heap tuple)
(ì•„! ì´ë˜ì„œ tuple ì˜ header ê°€ ìˆëŠ”ê±°êµ¬ë‚˜! t_ctid !!) 
ë°ì´í„°ë¥¼ ì½ì„ë•Œ, postgreSQL ì€ ê°ê°ì˜ íŠ¸ëœì­ì…˜ì˜ ìš”ì²­ì— ë”°ë¼. ì ì ˆí•œ ë²„ì „ì˜ ë°ì´í„°ë¥¼ ì„ íƒí•œë‹¤ - visibility check rules ë¥¼ ì ìš©í•´ì„œ, 

SI ëŠ” ANSI SQL-92 standard ì— ì •ì˜ë˜ì–´ ìˆëŠ” 3ê°€ì§€ anomaliy ë¥¼ í—ˆìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
Dirty Reads, Non-repeatable Reads, ê·¸ë¦¬ê³  phantom reads.
ê·¸ëŸ¬ë‚˜, SI ëŠ” ì§„ì •í•œ serializability ë¥¼ ì´ë£° ìˆ˜ ì—†ëŠ”ë° ê·¸ ì´ìœ ëŠ” SI ëŠ” serialization anomaly - Write skew ê·¸ë¦¬ê³  Read-only Transacition skew ë“±ì„ í—ˆìš©í•˜ê¸° ë•Œë¬¸ì´ë‹¤.
ì°¸ê³ ë¡œ Ansi SQL-92 í‘œì¤€ì€ í´ë˜ì‹í•œ serializability ì— ê·¼ê±°í•˜ê¸° ë•Œë¬¸ì— í˜„ëŒ€ì—ì„œì˜ ì •ì˜ì™€ëŠ” ë™ì¼í•˜ì§€ ì•Šë‹¤ëŠ” ê²ƒì„ ì•Œì•„ë‘ì–´ì•¼ í•œë‹¤.

ì´ëŸ¬í•œ ì´ìŠˆë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, Serializable Snapshot Isolation (SSI) ê°€ ë²„ì „ 9.1 ì— ì¶”ê°€ë˜ì—ˆë‹¤.
SSI ëŠ” Serialization anomalies ë¥¼ íƒì§€í•  ìˆ˜ ìˆê³  ê·¸ëŸ¬í•œ anomalies ì— ì¼ì–´ë‚œ ì¶©ëŒì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
ì´ì— ë”°ë¼ 9,1 ì´ìƒì˜ PostgreSQL ì—ì„œëŠ” Serializable isolation level ì„ ì§€ì›í•œë‹¤.

### txid

postgreSQL ì˜ txid ëŠ” 4ë°”ì´íŠ¸ - 32ë¹„íŠ¸ unsigned Integer ì´ë‹¤.
3ê°€ì§€ íŠ¹ë³„í•œ txid ê°€ ìˆë‹¤ -> invalid txid ë¥¼ ëœ»í•˜ëŠ” 0, BootStrap ì„ ëœ»í•˜ëŠ” 1 (ë°ì´í„°ë² ì´ìŠ¤ í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™” ì¼ë•Œë§Œ ì“°ì¸ë‹¤),
ê·¸ë¦¬ê³  Frozen ì„ ì˜ë¯¸í•˜ëŠ” 2.

txid ë¼ë¦¬ëŠ” ë¹„êµê°€ ê°€ëŠ¥í•˜ë‹¤.
ì˜ˆë¥¼ ë“¤ë©´ txid 100 ì¼ë•Œ txid ê°€ 100ë³´ë‹¤ í° íŠ¸ëœì­ì…˜ì€ 'ë¯¸ë˜' ì˜ íŠ¸ëœì­ì…˜ì´ê³  invisible í•˜ì§€ë§Œ
100ë³´ë‹¤ ì‘ì€ ê°’ì˜ íŠ¸ëœì­ì…˜ì€ 'ê³¼ê±°' ì˜ íŠ¸ëœì­ì…˜ì´ê³  visible í•œ íŠ¸ëœì­ì…˜ì´ë‹¤.

txid ëŠ” 4 billion ì˜ í¬ê¸°ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  í”„ë¡œë•ì…˜ ë ˆë²¨ì—ì„œëŠ” ë¶€ì¡±í•˜ê¸° ë–„ë¬¸ì— txid ê³µê°„ì„ í•˜ë‚˜ì˜ circle ë¡œ ë‹¤ë£¬ë‹¤.
ì´ì „ì˜ 2.1 bilion ì€ ê³¼ê±°, ë‹¤ìŒì˜ 2.1 billon ì„ ê°€ì§„ txid ëŠ” 'ë¯¸ë˜' ë¡œ ê°„ì£¼í•œë‹¤.

ì´ ì´ìŠˆë¥¼ txid wraparound problem ì´ë¼ê³  í•œë‹¤.



## What is @MockBean and its usage


```java
public class TicketValidator {
    private CustomerRepository customerRepository;

    private TicketRepository ticketRepository;

    public boolean validate(Long customerId, String code) {
        customerRepository.findById(customerId)
          .orElseThrow(() -> new RuntimeException("Customer not found"));

        ticketRepository.findByCode(code)
          .orElseThrow(() -> new RuntimeException("Ticket with given code not found"));
        return true;
    }
}
```

íŠ¹ì •í•œ bean ì„ ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šê³  ê·¸ê±¸ í‰ë‚´ë‚´ëŠ” ê°ì²´ë¥¼ ì˜ì¡´ì„±ì— ì£¼ì…í•œë‹¤.
ê·¸ë¦¬ê³  ê·¸ mocked version bean ì€ spring ì˜ application context ì— ì¶”ê°€ê°€ ëœë‹¤.
ê·¸ë˜ì„œ ì´ë¯¸ application contxt ì— ê°™ì€ 'íƒ€ì…' ì˜ bean ì´ ìˆì„ ê²½ìš°, ê·¸ê±¸ mock bean ì´ ëŒ€ì²´í•œë‹¤.

ê·¸ë¦¬ê³  ìš°ë¦¬ê°€ mock, ì¦‰ í‰ë‚´ë‚´ê³  ì‹¶ì€ í•„ë“œë‚˜ test class level ì— ì ìš©í•  ìˆ˜ ìˆë‹¤.

ìœ„ ì½”ë“œì—ì„œ í•„ë“œ ë ˆë²¨ì— ì ìš©í•´ë³´ë©´

```java
class MockBeanTicketValidatorUnitTest {
    @MockBean
    private CustomerRepository customerRepository;

    @Autowired
    private TicketRepository ticketRepository;

    @Autowired
    private TicketValidator ticketValidator;

    @Test
    void givenUnknownCustomer_whenValidate_thenThrowException() {
        String code = UUID.randomUUID().toString();
        when(customerRepository.findById(any())).thenReturn(Optional.empty());

        assertThrows(RuntimeException.class, () -> ticketValidator.validate(1L, code));
    }
}
```


> **One thing to keep in mind is that we canâ€™t use theÂ _@MockBean_Â annotation to mock a beanâ€™s behavior during the application context refresh.**

-> ë¬´ìŠ¨ ì˜ë¯¸ëƒë©´, Mock Bean ì€ ì• ì´ˆì— Application Context ê°€ ë§Œë“¤ì–´ì§€ê³  ë‚˜ì„œ ê¸°ì¡´ bean ì„ Mock bean ìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” ê²ƒì´ê¸° ë–„ë¬¸ì—
Application context ê°€ ìƒì„±ë˜ëŠ” ê³¼ì •ì—ì„œ ê¸°ì¡´ í´ë˜ìŠ¤ê°€ ë¯¸ì¹˜ëŠ” ì˜í–¥ì€ ì´ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ì—†ë‹¤ëŠ” ì–˜ê¸°ì´ë‹¤.
(Application refresh ê°€ application ì´ ì˜¬ë¼ê°€ëŠ”/ìƒì„±ë˜ëŠ” ê²ƒì„ ì˜ë¯¸í•¨)

1. ì»¨í…ìŠ¤íŠ¸ ìƒì„± â†’
2. ë¹ˆ ì •ì˜/ìƒì„±, ì˜ì¡´ì„± ì£¼ì…,Â `@PostConstruct`, ì´ˆê¸°í™” ë¡œì§ ì‹¤í–‰ â†’
3. ê·¸ ë‹¤ìŒì—Â `@MockBean`ìœ¼ë¡œ í•´ë‹¹ íƒ€ì… ë¹ˆì„ mock ì¸ìŠ¤í„´ìŠ¤ë¡œ êµì²´.

Â â€œì• í”Œë¦¬ì¼€ì´ì…˜ ë¶€íŒ… ì‹œ íŠ¹ì • ë¹ˆì´ DBë¥¼ í•œë²ˆ ì¡°íšŒí•˜ëŠ”ë°, ê·¸ DB í˜¸ì¶œì„ mock ìœ¼ë¡œ ë°”ê¿”ì„œ ë¶€íŒ… ë¡œì§ì˜ ë™ì‘ì„ ì œì–´í•˜ê³  ì‹¶ë‹¤â€ ê°™ì€ ê±´Â `@MockBean`ìœ¼ë¡œëŠ” ëª» í•œë‹¤ëŠ” ëœ»

ì–´ë…¸í…Œì´ì…˜ ì •ì˜ì— @Repeatable ì´ ìˆê¸°ë•Œë¬¸ì— í•œ í´ë˜ìŠ¤ì— ì—¬ëŸ¬ë²ˆ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

```java
@MockBean(CustomerRepository.class)              // -> ì´ê²Œ ë°”ë¡œ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ë ˆë²¨ì— ì‚¬ìš©í•˜ëŠ” ê²ƒ!
@MockBean(TicketRepository.class)
@SpringBootTest(classes = Application.class)
class MockBeanTicketValidatorUnitTest {
    @Autowired
    private CustomerRepository customerRepository;

    @Autowired
    private TicketRepository ticketRepository;

    @Autowired
    private TicketValidator ticketValidator;

    // ...
}
```

#### ì˜¤í•´

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ í•œê°€ì§€ ì£¼ì˜í•  ì ì´ ìˆëŠ”ë°, @_MockBean_ ì„ ì“´ë‹¤ê³  í•´ì„œ
ì „ì²´ Spring Application Context ê°€ ì™„ì „ ë¶ˆëŸ¬ì™€ì§€ì§€ ì•ŠëŠ”ë‹¤.

í˜„ì¬ ë¡œë”©ë˜ì–´ ìˆëŠ” Application Context ì— Mock Bean ì„ ì£¼ì…í•˜ëŠ” ê²ƒ ë¿ì´ë‹¤.


#### Deprecated

spring boot 4.0.0 ë²„ì „ ë¶€í„°ëŠ” Spring Framework ì˜ 6.2 @_MockitoBean_ ìœ¼ë¡œ ëŒ€ì²´ë˜ëŠ”ë°
ì›ë˜ @MockBean ì€ ìŠ¤í”„ë§ ë¶€íŠ¸ íŒ€ì´ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ë˜ ê¸°ëŠ¥ì¸ë°
ì´ê²Œ ë„ˆë¬´ ìœ ìš©í•˜ë‹¤ë³´ë‹ˆ ìŠ¤í”„ë§ë¶€íŠ¸ë¥¼ ì“°ì§€ ì•ŠëŠ” ë‹¤ë¥¸ ìŠ¤í”„ë§ ì‚¬ìš©ìë“¤ë„ ì´ê±¸ ì“°ê³  ì‹¶ì–´í•˜ê¸° ë•Œë¬¸ì´ë€ë‹¤.


### ê·¸ë˜ì„œ? @MockBean ì˜ ì˜ì˜ëŠ” ë¬´ì—‡ì¸ê°€ ?

```java

// 1. @MockBean 
// -> Springì—ê²Œ "ì´ ë¹ˆì„ Mockitoë¡œ ë§Œë“  ê°€ì§œ ê°ì²´(Mock)ë¡œ ë°”ê¿”ì¹˜ê¸° í•´ì¤˜"ë¼ê³  ìš”ì²­í•˜ëŠ” ê²ƒ 
@MockBean private ProductService productService;

// ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œ

// DTO í´ë˜ìŠ¤
public class ProductResponse {
    private String productName; // í•„ë“œëª…ì´ productName
    // Getter ...
}

@GetMapping("/products/{id}")
public ResponseEntity<ProductResponse> getProduct(@PathVariable Long id) {
    return ResponseEntity.ok(new ProductResponse("MacBook"));
}

------------------------------------------------------------

// ì¡ì•„ë‚´ëŠ” ì½”ë“œ

@Test
void getProduct_JsonFieldMismatch_ShouldFail() throws Exception {
    // given
    ProductResponse mockResponse = new ProductResponse("MacBook");
    given(productService.getProduct(1L)).willReturn(mockResponse);

    // when & then
    mockMvc.perform(get("/products/1"))
            .andExpect(status().isOk())
            // ì‹¤íŒ¨! ì‹¤ì œ JSONì€ {"productName": "MacBook"} ì´ë¼ $.nameì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
            .andExpect(jsonPath("$.name").value("MacBook")); 
}
```

@MockBean, given, verify ëª¨ë‘ Mockito ë¬¸ë²•ì´ë‹¤.

| ì½”ë“œ                     | ë‹´ë‹¹ì                  | ì—­í•                                         |
| ---------------------- | -------------------- | ----------------------------------------- |
| `@WebMvcTest`          | **Spring Boot**      | Controller í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í™˜ê²½(Context)ì„ ê¹”ì•„ì¤Œ       |
| `mockMvc.perform(...)` | **Spring Test**      | HTTP ìš”ì²­ì„ ë³´ë‚´ëŠ” ì²™ ì—°ê¸°í•¨ (ë¸Œë¼ìš°ì € ì—­í• )              |
| `@MockBean`            | **Spring + Mockito** | **Mockito**ë¡œ ê°€ì§œë¥¼ ë§Œë“¤ê³ , **Spring**ì´ ê·¸ê±¸ ê°ˆì•„ë¼ì›€ |
| `given(...)`           | **Mockito**          | ê°€ì§œ ê°ì²´ì—ê²Œ ëŒ€ì‚¬(Return ê°’)ë¥¼ ê°€ë¥´ì¹¨                 |
| `andExpect(...)`       | **Spring Test**      | ì‘ë‹µì´ ë§ëŠ”ì§€ ì±„ì í•¨                               |




### @MockBeans

ì—¬ëŸ¬ê°œì˜ @MockBean ì–´ë…¸í…Œì´ì…˜ì˜ ì§‘í•©ì„ ì˜ë¯¸í•˜ê³ , ê·¸ @MockBean ë“¤ì˜ ì»¨í…Œì´ë„ˆ ì—­í• ì„ í•¨

ì¼ë‹¨ MockBean ë“¤ì„ í•œë° ë¬¶ëŠ”ë°, ì´ê±´ ì¼ë‹¨ @MockBean ì„ ê° í´ë˜ìŠ¤ë§ˆë‹¤ ìƒˆë¡œìš´ line ìœ¼ë¡œ ì •ì˜í•˜ëŠ” ê²ƒê³¼ ë§ˆì°¬ê°€ì§€ì´ë‹¤.
ìë°” 8 ë²„ì „ë¶€í„°ëŠ” @MockBean ì— @Repeatable ê°€ ì¶”ê°€ë˜ì–´ ì—¬ëŸ¬ë²ˆ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì„œ ì‚¬ì‹¤ ë¶ˆí•„ìš”í•˜ë‹¤ê³  ìƒê°í•  ìˆ˜ë„ ìˆìŒ.

ê°€ì¥ í° ì˜ì˜ëŠ” í•œ ê³³ì— Mock í•  í´ë˜ìŠ¤ë“¤ì„ ëª¨ì•„ì„œ ì •ì˜í•˜ëŠ” ê²ƒ.

ì§€ê¸ˆì—ì„œëŠ” ë”±íˆ ì“¸ëª¨ ì—†ëŠ” ê²ƒ ê°™ë‹¤.

```java
@MockBeans({@MockBean(CustomerRepository.class), @MockBean(TicketRepository.class)})
@SpringBootTest(classes = Application.class)
class MockBeansTicketValidatorUnitTest {
    @Autowired
    private CustomerRepository customerRepository;

    @Autowired
    private TicketRepository ticketRepository;

    @Autowired
    private TicketValidator ticketValidator;

    // ...
}
```



## Controller ë¥¼ í…ŒìŠ¤íŠ¸í•œë‹¤ëŠ” ê²ƒì€ ë­˜ í…ŒìŠ¤íŠ¸í•œë‹¤ëŠ” ê²ƒì¸ê°€ ?



```java
// src/test/java/.../ProductControllerTest.java

@WebMvcTest(ProductController.class) // 1. í…ŒìŠ¤íŠ¸í•  ì»¨íŠ¸ë¡¤ëŸ¬ ì§€ì •
class ProductControllerTest {

    @Autowired
    private MockMvc mockMvc; // HTTP ìš”ì²­ì„ í‰ë‚´ë‚´ëŠ” ë„êµ¬

    @MockBean
    private ProductService productService; // 2. ì„œë¹„ìŠ¤ëŠ” ê°€ì§œ ê°ì²´ë¡œ ëŒ€ì²´

    @Test
    @DisplayName("ìƒí’ˆ ì¡°íšŒ ì„±ê³µ ì‹œ 200 OKì™€ JSON ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤")
    void getProduct_ShouldReturnProduct() throws Exception {
        // given: ì„œë¹„ìŠ¤ê°€ ì–´ë–¤ ë™ì‘ì„ í• ì§€ ì •ì˜ (Stubbing)
        ProductResponse mockResponse = new ProductResponse(1L, "MacBook Pro", 2500000);
        given(productService.getProduct(1L)).willReturn(mockResponse);

        // when & then: GET ìš”ì²­ì„ ë³´ë‚´ê³  ê²°ê³¼ë¥¼ ê²€ì¦
        mockMvc.perform(get("/products/1") // ì•„ì§ /products ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ (ì‹¤íŒ¨ ì˜ˆì •)
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk()) // HTTP 200 í™•ì¸
                .andExpect(jsonPath("$.name").value("MacBook Pro")) // JSON í•„ë“œ í™•ì¸
                .andExpect(jsonPath("$.price").value(2500000));
    }
}
```


```java
ProductResponse mockResponse = new ProductResponse(1L, "MacBook Pro", 2500000);
given(productService.getProduct(1L)).willReturn(mockResponse);
```

-  ì™œ ì“°ëŠ”ê°€?

ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ê²€ì‚¬ëŠ” service ê°€ ì¼ì„ ì˜í•˜ëƒê°€ ì•„ë‹ˆë‹¤.
ì„œë¹„ìŠ¤ê°€ ë°ì´í„°ë¥¼ ì¤¬ì„ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì–´ë–»ê²Œ ë°˜ì‘í•˜ëƒê°€ ê´€ì‹¬ì‚¬ì´ë‹¤.
Service ë¡œì§ì´ ë³µì¡í•˜ë˜ db ê°€ ì£½ì—ˆë˜ ìƒê´€ì—†ì´, ì¼ë‹¨ service ê°€ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¤¬ë‹¤ëŠ” ê°€ì • í•˜ì— 
Controller ì˜ í–‰ë™ì„ ê³ ë¦½ì‹œì¼œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒ.

ê·¸ëŸ¬ë‹ˆê¹Œ ì¼ë‹¨ mockResponse ë¥¼ ì„œë¹„ìŠ¤ê°€ ì¤€ë‹¤ê³  ê°€ì •í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ë‹¤.

```java
mockMvc.perform(get("/products/1") // ì•„ì§ /products ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ (ì‹¤íŒ¨ ì˜ˆì •)
                .contentType(MediaType.APPLICATION_JSON))
```

- ì™œ ì“°ëŠ”ê°€ ?

ì‹¤ì œ tomcat ì„œë²„ë¥¼ ë„ìš°ì§€ ì•Šê³  Http ìš”ì²­ì„ í‰ë‚´ë‚´ê¸° ìœ„í•¨.
get("/products/1") ì€ ì„œë²„ì— http ìš”ì²­ì„ get ìœ¼ë¡œ ë³´ë‚´ëŠ”ê²ƒê³¼ ë˜‘ê°™ì€ íš¨ê³¼ë¥¼ ë‚¸ë‹¤.
content type ì€ json í˜•ì‹ìœ¼ë¡œ ëŒ€í™”í•  ê²ƒì´ë¼ëŠ” ì–˜ê¸°.


```java
.andExpect(status().isOk()) // HTTP 200 í™•ì¸
.andExpect(jsonPath("$.name").value("MacBook Pro")) // JSON í•„ë“œ í™•ì¸
.andExpect(jsonPath("$.price").value(2500000));
```

`status().isOk()` -> ì„œë²„ê°€ ì•ˆ í„°ì§€ê³  ì •ìƒ ì‘ë‹µì„ ì£¼ì—ˆëŠ”ê°€ ? (400, 500 ì´ ì•„ë‹ˆë¼ ?) ì—¬ê¸°ì„œ status ëŠ” httpStatus ë¥¼ ë§í•˜ëŠ” ë“¯.
`jsonPath( ... ) ` -> ìë°” ê°ì²´ê°€ (ProductResponse mockResponse) json ë¬¸ìì—´ (`{"name": "MacBook Pro"}`) ë¡œ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜ (serialization) ë˜ì—ˆëŠ”ê°€ ?
í´ë¼ì´ì–¸íŠ¸ê°€ ê¸°ëŒ€í•˜ëŠ” í•„ë“œëª…ì´ ì •í™•íˆ ë“¤ì–´ê°€ìˆëŠ”ê°€? ì´ë‹¤.


ì¦‰ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í…ŒìŠ¤íŠ¸ í•œë‹¤ëŠ” ê²ƒì€

1. url, parameter ë¥¼ ì •í™•íˆ ë°›ì•˜ëŠ”ê°€ (í•„ìš”í•œ ë°ì´í„°ë¥¼ ì˜ ë°›ì•˜ëŠ”ê°€)
2. ì„œë¹„ìŠ¤ì—ì„œ ë¦¬í„´ê°’ì„ ë‚´ì–´ì£¼ë©´, ê·¸ê±¸ json ì— ì˜ ë‹´ì•˜ëŠ”ê°€
3. ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´, ë‹¤ë¥¸ http status ë¡œ ì˜ ë‚´ë³´ë‚´ëŠ”ê°€

### ì£¼ì˜í•  ì 

@_WebMvcTest_ ì•ˆì— ì–´ë–¤ ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ë„ ì§‘ì–´ë„£ì§€ ì•Šìœ¼ë©´ 
ëª¨ë“  controller ë¥¼ ë‹¤ ë¡œë”©í•˜ë ¤ê³  í•œë‹¤.

ê·¸ëŸ¬ë‹¤ë³´ë‹ˆ ë‚´ê°€ í…ŒìŠ¤íŠ¸í•˜ë ¤ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì˜ì¡´ì„±ë§Œ @_MockBean_ ìœ¼ë¡œ ì£¼ì…í•´ë´¤ì
ë‹¤ë¥¸ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì˜ì¡´ì„±ì´ í•´ê²°ì´ ì•ˆë˜ì„œ í…ŒìŠ¤íŠ¸ ì§„í–‰ì´ ì•ˆëœë‹¤.


### êµ¬ì²´ì ì¸ ì˜ˆì‹œ

1. **URL ê²½ë¡œ ì‹¤ìˆ˜ (404 Error)**
    
    - _ì½”ë“œ:_Â `@GetMapping("/produts/{id}")`Â (ì˜¤íƒ€ ë°œìƒ)
        
    - _í…ŒìŠ¤íŠ¸:_Â `/products/1`ë¡œ ìš”ì²­í–ˆëŠ”ë° 404ê°€ ëœ¸. ->Â **ì¡ì•˜ë‹¤!**

```java
// ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œ

@RestController
public class ProductController {
    // ì˜¤íƒ€ ë°œìƒ: productsê°€ ì•„ë‹ˆë¼ produtsë¡œ ì ìŒ
    @GetMapping("/produts/{id}") 
    public ResponseEntity<ProductResponse> getProduct(@PathVariable Long id) {
        return ResponseEntity.ok(new ProductResponse(1L, "MacBook", 1000));
    }
}
```

```java
// ì¡ì•„ë‚´ëŠ” ì½”ë“œ

@Test
void getProduct_UrlTypo_ShouldFail() throws Exception {
    // when & then
    mockMvc.perform(get("/products/1") // í´ë¼ì´ì–¸íŠ¸ëŠ” ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ìš”ì²­
            .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isOk()); // ì‹¤íŒ¨! ì‹¤ì œë¡œëŠ” 404 Not Foundê°€ ëœ¸
}

```



2. **íŒŒë¼ë¯¸í„° ëˆ„ë½ (400 Error)**
    
    - _ì½”ë“œ:_Â `@PathVariable`ì„ ë¹¼ë¨¹ê±°ë‚˜Â `@RequestParam`Â ì„¤ì •ì„ ì˜ëª»í•¨.
        
    - _í…ŒìŠ¤íŠ¸:_Â Serviceì— IDê°€ ì „ë‹¬ë˜ì§€ ì•ŠìŒ. ->Â **ì¡ì•˜ë‹¤!**

```java
@GetMapping("/products/{id}")
// @PathVariable ì–´ë…¸í…Œì´ì…˜ ëˆ„ë½!
public ResponseEntity<ProductResponse> getProduct(Long id) { 
    // idëŠ” nullì´ ë“¤ì–´ì˜¤ê±°ë‚˜, ë°”ì¸ë”© ì—ëŸ¬ê°€ ë°œìƒí•¨
    return ResponseEntity.ok(productService.getProduct(id));
}
```

```java
@Test
void getProduct_MissingAnnotation_ShouldFail() throws Exception {
    // given
    given(productService.getProduct(1L)).willReturn(new ProductResponse(1L, "MacBook", 1000));

    // when & then
    mockMvc.perform(get("/products/1"))
            .andExpect(status().isOk());
            
    // ì¶”ê°€ ê²€ì¦: ì„œë¹„ìŠ¤ê°€ '1L'ì´ë¼ëŠ” IDë¡œ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸
    // ì‹¤ì œë¡œëŠ” idê°€ nullë¡œ ë„˜ì–´ê°€ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚˜ì„œ ì´ ê²€ì¦ì´ ì‹¤íŒ¨í•¨
    verify(productService).getProduct(1L); 
}
```


        
3. **JSON í•„ë“œëª… ë³€ê²½ (Contract ìœ„ë°˜)**
    
    - _ìƒí™©:_Â ServiceëŠ”Â `productName`ì´ë¼ê³  ë°ì´í„°ë¥¼ ì¤¬ëŠ”ë°, í”„ë¡ íŠ¸ì—”ë“œ ì•½ì†ì€Â `name`ì´ì–´ì•¼ í•¨.
        
    - _í…ŒìŠ¤íŠ¸:_Â `jsonPath("$.name")`ì„ ê¸°ëŒ€í–ˆëŠ”ë°, ì‹¤ì œ ì‘ë‹µì—Â `name`Â í•„ë“œê°€ ì—†ìŒ. ->Â **ì¡ì•˜ë‹¤!**

```java
// ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œ

// DTO í´ë˜ìŠ¤
public class ProductResponse {
    private String productName; // í•„ë“œëª…ì´ productName
    // Getter ...
}

@GetMapping("/products/{id}")
public ResponseEntity<ProductResponse> getProduct(@PathVariable Long id) {
    return ResponseEntity.ok(new ProductResponse("MacBook"));
}
```

```java
// ì¡ì•„ë‚´ëŠ” ì½”ë“œ

@Test
void getProduct_JsonFieldMismatch_ShouldFail() throws Exception {
    // given
    ProductResponse mockResponse = new ProductResponse("MacBook");
    given(productService.getProduct(1L)).willReturn(mockResponse);

    // when & then
    mockMvc.perform(get("/products/1"))
            .andExpect(status().isOk())
            // ì‹¤íŒ¨! ì‹¤ì œ JSONì€ {"productName": "MacBook"} ì´ë¼ $.nameì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
            .andExpect(jsonPath("$.name").value("MacBook")); 
}
```


4. **HTTP ìƒíƒœ ì½”ë“œ ì‹¤ìˆ˜**
    
    - _ìƒí™©:_Â ë¬¼ê±´ì„ ìƒì„±(`POST`)í–ˆëŠ”ë°Â `200 OK`ë¥¼ ë¦¬í„´í•¨. (REST API í‘œì¤€ì€Â `201 Created`ê°€ ë” ì ì ˆí•¨)
        
    - _í…ŒìŠ¤íŠ¸:_Â `.andExpect(status().isCreated())`ë¡œ ê²€ì¦í•´ì„œÂ `200`ì´ ì˜¤ë©´ ì‹¤íŒ¨ì‹œí‚´. ->Â **ì¡ì•˜ë‹¤!**

```java
// ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œ

@PostMapping("/products")
public ResponseEntity<Void> createProduct(@RequestBody ProductRequest request) {
    productService.createProduct(request);
    // ì‹¤ìˆ˜: 201ì´ ì•„ë‹ˆë¼ 200ì„ ë°˜í™˜í•¨
    return ResponseEntity.ok().build(); 
}
```

```java
// ì¡ì•„ë‚´ëŠ” ì½”ë“œ

@Test
void createProduct_WrongStatus_ShouldFail() throws Exception {
    // when & then
    mockMvc.perform(post("/products")
            .contentType(MediaType.APPLICATION_JSON)
            .content("{\"name\":\"iPad\"}"))
            // ì‹¤íŒ¨! 200ì´ ë°˜í™˜ë˜ì—ˆìœ¼ë¯€ë¡œ í…ŒìŠ¤íŠ¸ê°€ ê¹¨ì§
            .andExpect(status().isCreated()); 
}
```


### given ì„ ì™œ ì“°ëŠ”ê°€ ?

ìœ„ì— ì˜ˆì‹œ 3ë²ˆ json í•„ë“œëª… ë³€ê²½ì—ì„œ

```java
// ì‹¤íŒ¨í•˜ëŠ” ì½”ë“œ

// DTO í´ë˜ìŠ¤
public class ProductResponse {
    private String productName; // í•„ë“œëª…ì´ productName
    // Getter ...
}

@GetMapping("/products/{id}")
public ResponseEntity<ProductResponse> getProduct(@PathVariable Long id) {
    return ResponseEntity.ok(new ProductResponse("MacBook"));
}

------------------------------------------------------------

// ì¡ì•„ë‚´ëŠ” ì½”ë“œ

@Test
void getProduct_JsonFieldMismatch_ShouldFail() throws Exception {
    // given
    ProductResponse mockResponse = new ProductResponse("MacBook");
    given(productService.getProduct(1L)).willReturn(mockResponse);

    // when & then
    mockMvc.perform(get("/products/1"))
            .andExpect(status().isOk())
            // ì‹¤íŒ¨! ì‹¤ì œ JSONì€ {"productName": "MacBook"} ì´ë¼ $.nameì„ ì°¾ì„ ìˆ˜ ì—†ìŒ
            .andExpect(jsonPath("$.name").value("MacBook")); 
}
```

given ì„ ì“°ì§€ ì•Šìœ¼ë©´ ?

productService ê°€ mock ê°ì²´ì´ê¸° ë•Œë¬¸ì— given ì„ ì„¤ì •í•´ì£¼ì§€ ì•Šìœ¼ë©´ 1L ì´ë¼ëŠ” ì…ë ¥ê°’ì„ ì¤¬ì„ë•Œ
mockResponse ë¥¼ í…ŒìŠ¤íŠ¸ì—ì„œ ë°˜í™˜í•˜ì§€ ì•ŠëŠ”ë‹¤.

```java
// ì‹¤ì œ ì»¨íŠ¸ë¡¤ëŸ¬ ë‚´ë¶€ ìƒí™©

@GetMapping("/products/{id}")
public ResponseEntity<ProductResponse> getProduct(@PathVariable Long id) {
    // 1. ì„œë¹„ìŠ¤ í˜¸ì¶œ
    // givenì´ ì—†ìœ¼ë¯€ë¡œ, Mockì¸ productServiceëŠ” ë©ì²­í•˜ê²Œ nullì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    ProductResponse response = productService.getProduct(id); // ê²°ê³¼: null
    
    // 2. ì‘ë‹µ ë°˜í™˜
    // responseê°€ nullì´ë¯€ë¡œ, ë¹ˆ ê»ë°ê¸°ê°€ ë‚˜ê°‘ë‹ˆë‹¤.
    return ResponseEntity.ok(response); 
}
```


### verify ë¥¼ ì™œ ì“°ëŠ”ê°€ ?

ìœ„ì— íŒŒë¼ë¯¸í„° ëˆ„ë½ í…ŒìŠ¤íŠ¸ì—ì„œ

```java
@GetMapping("/products/{id}")
// @PathVariable ì–´ë…¸í…Œì´ì…˜ ëˆ„ë½!
public ResponseEntity<ProductResponse> getProduct(Long id) { 
    // idëŠ” nullì´ ë“¤ì–´ì˜¤ê±°ë‚˜, ë°”ì¸ë”© ì—ëŸ¬ê°€ ë°œìƒí•¨
    return ResponseEntity.ok(productService.getProduct(id));
}
```

```java
@Test
void getProduct_MissingAnnotation_ShouldFail() throws Exception {
    // given
    given(productService.getProduct(1L)).willReturn(new ProductResponse(1L, "MacBook", 1000));

    // when & then
    mockMvc.perform(get("/products/1"))
            .andExpect(status().isOk());
            
    // ì¶”ê°€ ê²€ì¦: ì„œë¹„ìŠ¤ê°€ '1L'ì´ë¼ëŠ” IDë¡œ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸
    // ì‹¤ì œë¡œëŠ” idê°€ nullë¡œ ë„˜ì–´ê°€ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚˜ì„œ ì´ ê²€ì¦ì´ ì‹¤íŒ¨í•¨
    verify(productService).getProduct(1L); 
}
```


- ìƒí™©:Â `@PathVariable`ì„ ë¹¼ë¨¹ì€ ë²„ê·¸ ì½”ë“œ

```java
// Controller (ë²„ê·¸ ìˆìŒ)
public ResponseEntity<ProductResponse> getProduct(Long id) { 
    // @PathVariableì´ ì—†ì–´ì„œ, URLë¡œ ë„˜ì–´ì˜¨ 1ì´ idì— ì•ˆ ë‹´ê¹€.
    // idëŠ” nullì´ ë©ë‹ˆë‹¤.
    
    // ê·¸ë˜ì„œ ì„œë¹„ìŠ¤ì— nullì„ ë„˜ê¹€
    ProductResponse response = productService.getProduct(id); // getProduct(null) í˜¸ì¶œ
    
    return ResponseEntity.ok(response);
}
```

- verify ê°€ ì—†ì„ë•Œì˜ íë¦„
```java
@Test
void getProduct_WithoutVerify() throws Exception {
    // 1. given: "1Lì„ ë‹¬ë¼ê³  í•˜ë©´" MacBookì„ ì¤˜ë¼. (nullì„ ë‹¬ë¼ê³  í•  ë• ë­ ì¤„ì§€ ë§ ì•ˆ í•¨)
    given(productService.getProduct(1L)).willReturn(new ProductResponse(...));

    // 2. perform: /products/1 í˜¸ì¶œ
    mockMvc.perform(get("/products/1"))
            .andExpect(status().isOk()); // 3. 200 OK ê²€ì¦
}
```

**\[ì‹¤í–‰ ê²°ê³¼]**

1. URLÂ `/products/1`Â í˜¸ì¶œë¨.
    
2. Controller ì§„ì…. í•˜ì§€ë§ŒÂ `id`ëŠ” `null`ì´ ë¨.
    
3. Controllerê°€Â `productService.getProduct(null)`ì„ í˜¸ì¶œí•¨.
    
4. **Mockì˜ íŠ¹ì§•:**Â ì‹œí‚¤ì§€ ì•Šì€ ì£¼ë¬¸(`null`)ì´ ë“¤ì–´ì˜¤ë©´ ì—ëŸ¬ë¥¼ ë‚´ëŠ” ê²Œ ì•„ë‹ˆë¼, ê·¸ëƒ¥ `null`ì„ ì¡°ìš©íˆ ë¦¬í„´í•¨.
    
5. ControllerëŠ”Â `null`ì„ ë°›ì•„ì„œÂ `ResponseEntity.ok(null)`ì„ ë°˜í™˜í•¨.
    
6. ê²°ê³¼ì ìœ¼ë¡œ HTTP StatusëŠ”Â **200 OK**ê°€ ë‚˜ê°. (ë³¸ë¬¸ì€ ë¹„ì–´ìˆì§€ë§Œ 200ì€ ë§ìŒ)
    
7. `.andExpect(status().isOk())`Â ->Â **í†µê³¼! (ì´ˆë¡ë¶ˆ)**Â ğŸ˜±


**ê²°ê³¼:**Â ì½”ë“œëŠ” ë§ê°€ì ¸ì„œ IDë¥¼ ì „ë‹¬ ëª» í•˜ê³  ìˆëŠ”ë°, í…ŒìŠ¤íŠ¸ëŠ” "ì–´ì¨Œë“  200 ë–¨ì–´ì¡Œë„¤?" í•˜ê³  í†µê³¼ì‹œì¼œ ë²„ë¦°ë‹¤

- `verify`ê°€ ìˆì„ ë•Œì˜ íë¦„

```java
// ë§ˆì§€ë§‰ ì¤„ì— ì¶”ê°€
verify(productService).getProduct(1L); 
```

- **í…ŒìŠ¤íŠ¸ì˜ ì£¼ì¥:**Â "ì•¼ Mockito, ì•„ê¹Œ Controllerê°€ ì‹¤í–‰ë  ë•Œ ë¶„ëª…íˆÂ `getProduct(1L)`Â í˜¸ì¶œí–ˆì§€? í™•ì¸í•´ë´."
    
- **Mockito(CCTV):**Â "ì ê¹ë§Œ... ë¡œê·¸ ëŒë ¤ë³¼ê²Œ. ì–´? ì•„ê¹Œ ControllerëŠ”Â `getProduct(null)`ì„ í˜¸ì¶œí–ˆëŠ”ë°?Â `1L`ì´ ì•„ë‹Œë°?"
    
- **ê²°ê³¼:**Â **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ë¹¨ê°„ë¶ˆ)!**
    
	>_Argument(s) are different! Wanted: 1L, Actual: null_


ì°¸ê³ ë¡œ

```java
// ì´ ì¤„ì—ì„œ ì‹¤íŒ¨í•©ë‹ˆë‹¤.
.andExpect(jsonPath("$.name").value("MacBook")) 
```
ì´ëŸ° ë¬¸ì„ ì¶”ê°€í•´ë„ ì‹¤íŒ¨í•œë‹¤. 
ê·¸ëŸ¼ì—ë„ verify ê°€ ì—†ìœ¼ë©´ ì ˆëŒ€ë¡œ ë²„ê·¸ë¥¼ ëª» ì¡ì•„ë‚´ëŠ” ìƒí™©ì´ ìˆëŠ”ë°, ë°”ë¡œ ë¦¬í„´ê°’ì´ void ì€ ë©”ì„œë“œë¥¼ ì‹¤í–‰í• ë•Œì´ë‹¤.

- ì˜ˆì‹œ : ìƒí’ˆ ì‚­ì œ API


```java
// ë²„ê·¸ê°€ ìˆëŠ” ì‚­ì œ Controller

@DeleteMapping("/products/{id}")
// @PathVariable ëˆ„ë½! idëŠ” nullì´ ë¨.
public ResponseEntity<Void> deleteProduct(Long id) {
    // service.delete(null) í˜¸ì¶œë¨.
    // void ë©”ì„œë“œëŠ” ì•„ë¬´ê²ƒë„ ë°˜í™˜í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, Mockë„ ì•„ë¬´ ë¶ˆí‰ ì—†ì´ ê·¸ëƒ¥ ë„˜ì–´ê°.
    productService.deleteProduct(id); 
    
    // 204 No Content ë°˜í™˜
    return ResponseEntity.noContent().build();
}
```

```java
// verify ê°€ ì—†ëŠ” í…ŒìŠ¤íŠ¸ (ê±°ì§“ ì„±ê³µ)

@Test
void deleteProduct_Test() throws Exception {
    // when
    mockMvc.perform(delete("/products/1"))
            .andExpect(status().isNoContent()); // 204 í™•ì¸
            // ë°˜í™˜ë˜ëŠ” JSONì´ ì—†ìœ¼ë¯€ë¡œ jsonPath ê²€ì¦ ë¶ˆê°€!
}
```

- **ê²°ê³¼:**Â **í…ŒìŠ¤íŠ¸ í†µê³¼ (Green)**.
- **í˜„ì‹¤:**Â ì‹¤ì œë¡œëŠ” IDê°€ ì „ë‹¬ë˜ì§€ ì•Šì•„ ì‚­ì œê°€ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì—‰ëš±í•œ ê²Œ ì§€ì›Œì§ˆ ìˆ˜ë„ ìˆëŠ”ë°, í…ŒìŠ¤íŠ¸ëŠ” "ì„±ê³µ"ì´ë¼ê³  ê±°ì§“ë§ì„ í•©ë‹ˆë‹¤.


```java
// verify ê°€ ìˆëŠ” í…ŒìŠ¤íŠ¸ (ê²€ê±° ì„±ê³µ)

@Test
void deleteProduct_Test() throws Exception {
    // when
    mockMvc.perform(delete("/products/1"))
            .andExpect(status().isNoContent());

    // then: ë„ˆ ì•„ê¹Œ ì§„ì§œë¡œ 1L ì§€ìš°ë¼ê³  ì‹œì¼°ì–´?
    verify(productService).deleteProduct(1L); 
}
```


- ê²°ë¡ 

ì¡°íšŒì²˜ëŸ¼ ì‘ë‹µê°’ì´ ëª…í™•í•œ ê²½ìš°
-> jsonpath ë¡œë„ ì¶©ë¶„. í•˜ì§€ë§Œ verify ëŠ” ê³¼ì •ì„ íƒì§€í•˜ê¸° ë•Œë¬¸ì— ë” ë¹ ë¥¸ ì‹œì ë‚´ì—, ì •í™•í•œ ì‹œì ì— ë¬¸ì œë¥¼ íŒë‹¨í•  ìˆ˜ ìˆë‹¤.

ì‚­ì œ, ìˆ˜ì •, ë¹„ë™ê¸° ì²˜ëŸ¼ ì‘ë‹µê°’ì´ ì—†ê±°ë‚˜ ì¤‘ìš”í•˜ì§€ ì•Šì€ ê²½ìš°
-> verify ê°€ í•„ìˆ˜ì´ë‹¤. ë©”ì„œë“œì— ì–´ë–¤ ê°’ì´ ë„˜ì–´ê°€ëŠ”ì§€ ì •í™•íˆ íŒë‹¨í•´ì•¼ í•œë‹¤.


## Mockito.mock() vs @Mock vs @MockBean

https://www.perplexity.ai/search/mockito-mock-vs-mock-vs-mockbe-_24g_Cz7Sr27BS4XrV2XSg#4


@Mock ê³¼ Mockito.mock() ì€ ë‘˜ ë‹¤ Mockito ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì´ê³ ,
@Mock ì€ Mockito.mock() ì„ ì¢€ ë” í¸í•˜ê²Œ ì“°ê³  ì½”ë“œë¥¼ ëœ ì“°ê²Œ ë§Œë“¤ê²Œ í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ë‹¤.

ì˜ˆë¥¼ë“¤ì–´ Mockito.mock() ìœ¼ë¡œ ì˜ì¡´ì„±ì˜ mock ê°ì²´ë¥¼ ìƒì„±í•˜ë ¤ë©´
```java
@Test
public void testList() throws Exception {
    SingerService singerService = Mockito.mock(SingerService.class);
    when(singerService.findAll()).thenReturn(singers);
}
```
ì´ëŸ° ì‹ì¸ë°, 

@Mock ì„ ì“°ë©´
```java
@ExtendWith(MockitoExtension.class) // @Mock ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì½”ë“œ. MockitoAnnotations.initMocks(this) ìœ¼ë¡œë„ @Mock ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¡°ê±´ì„ ë§Œì¡±í•  ìˆ˜ ìˆë‹¤.
public class UserServiceTest {
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
}
```
ì´ë ‡ê²Œ ëœë‹¤.


| í•­ëª©                   | Mockito.mock()       | @Mock                 | @MockBean                    |
| -------------------- | -------------------- | --------------------- | ---------------------------- |
| ì œê³µì (Provider)       | Mockito library      | Mockito library       | Spring Boot Test             |
| Spring context ì—°ê´€    | ì—†ìŒ (No)              | ì—†ìŒ (No)               | ìˆìŒ (Yes)                     |
| ì‚¬ìš© ëª©ì  (Purpose)      | Programmatic mock ìƒì„± | Annotation ê¸°ë°˜ mock ìƒì„± | Spring beanì„ mockìœ¼ë¡œ ëŒ€ì²´       |
| ì í•©í•œ í…ŒìŠ¤íŠ¸ íƒ€ì…           | Unit test            | Unit test             | Integration test             |
| Dependency Injection | ìˆ˜ë™ ì£¼ì… í•„ìš”             | `@InjectMocks`ë¡œ ì£¼ì…    | Spring contextê°€ ìë™ ì£¼ì…        |
| í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì†ë„            | ë¹ ë¦„ (Fast)            | ë¹ ë¦„ (Fast)             | ëŠë¦¼ - Spring context loadingâ€‹ |


### Mock ê°ì²´ì˜ ë™ì‘ ì •ì˜ (usage)

Mock ê°ì²´ëŠ” ê°€ì§œ ê°ì²´ì´ë¯€ë¡œ, A ê°€ ë“¤ì–´ì˜¤ë©´ B ë¥¼ ë±‰ì–´ë¼ ë¼ê³  í–‰ë™ì„ ì§€ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.
ì´ê±¸ Stubbing ì´ë¼ê³  í•œë‹¤.

ëŒ€í‘œì ì¸ ë°©ë²•ì€ when(), @thenReturn() ì„ ì“°ëŠ” ê²ƒ.

```java
// ë¬¸ë²• êµ¬ì¡°
when(mockê°ì²´.ë©”ì„œë“œ(ì…ë ¥ê°’)).thenReturn(ë¦¬í„´ê°’);

// repository ì˜ˆì‹œ
Mockito.when(userRepository.findAll()).thenReturn(Arrays.asList(user1, user2));

Mockito.doReturn(mockUsers).when(userRepository).findAll();
```

### `when(mock.method()).thenReturn(value)` ê³¼ `doReturn(value).when(mock).method()` ë°©ì‹ì˜ ì°¨ì´

ì¼ë‹¨ ë‘˜ì´ í•˜ëŠ” ì¼ì€ ê°™ì´ stubbing í•˜ëŠ” ê²ƒì´ë‹¤. ê·¼ë° ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ë‹¤ë¥¸ë°...

#### `when(mock.method()).thenReturn(value)`

ì´ ë°©ì‹ì€ mock.method() ê°€ í•œë²ˆ ì‹¤í–‰ë  ìœ„í—˜ì´ ìˆë‹¤.
ë§Œì•½ ê·¸ ë©”ì„œë“œê°€ ì‹¤ì œ ë¡œì§ì„ íƒ€ì•¼í•˜ëŠ” @Spy ê°ì²´ê±°ë‚˜, return íƒ€ì…ì´ void ì¸ ê²½ìš° ì»´íŒŒì¼ ì—ëŸ¬ê°€ ë‚˜ê±°ë‚˜ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ê°€ í„°ì§ˆ ìˆ˜ ìˆìŒ

##### @Spy ê°ì²´ ?

-> @Mock ê³¼ ë°˜ëŒ€ì˜ íŠ¹ì§•ì„ ê°€ì§€ê³  ìˆë‹¤. @Mock ì€ ì§„ì§œê°™ì€ ê°€ì§œì§€ë§Œ, @Spy ê°ì²´ëŠ” ê°€ì§œê°™ì€ ì§„ì§œì´ë‹¤.

|íŠ¹ì§•|@Mock (ê°€ì§œ)|@Spy (ìŠ¤íŒŒì´/ê°ì‹œì)|
|---|---|---|
|**ë³¸ì²´**|ê»ë°ê¸°ë§Œ ìˆëŠ” ê°€ì§œ ê°ì²´|**ì‹¤ì œ ê°ì²´(Real Object)**|
|**ê¸°ë³¸ ë™ì‘**|ì•„ë¬´ëŸ° ë™ì‘ì„ í•˜ì§€ ì•ŠìŒ (null, 0 ë°˜í™˜)|**ì‹¤ì œ ë©”ì„œë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•¨**|
|**ëª©ì **|ì™¸ë¶€ ì˜ì¡´ì„±ì„ ì™„ì „íˆ ëŠê³  ì‹¶ì„ ë•Œ|ì‹¤ì œ ë¡œì§ì„ ëŒë¦¬ë©´ì„œÂ **ì¼ë¶€ë§Œ ì¡°ì‘**í•˜ê±°ë‚˜Â **í˜¸ì¶œ ì—¬ë¶€ë¥¼ ëª°ë˜ í™•ì¸**í•˜ê³  ì‹¶ì„ ë•Œ|
|**ë¹„ìœ **|ëŒ€ë³¸ë§Œ ì™¸ìš´Â **ëŒ€ì—­ ë°°ìš°**|ëª°ë˜ì¹´ë©”ë¼ë¥¼ ì°¬Â **ì‹¤ì œ ì§ì›**|

**ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ:**

> ë‹¹ì‹ ì´Â `UserService`ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì´ ì„œë¹„ìŠ¤ ì•ˆì—Â `checkPassword()`ë¼ëŠ” ë©”ì„œë“œê°€ ìˆìŠµë‹ˆë‹¤.
> 
> - ë‹¤ë¥¸ ë¡œì§ì€ ë‹¤ ì‹¤ì œ ì½”ë“œë¡œ ê²€ì¦í•˜ê³  ì‹¶ì€ë°,
>     
> - `checkPassword()`ë§Œ ë„ˆë¬´ ë³µì¡í•˜ê±°ë‚˜ ì™¸ë¶€ APIë¥¼ ì¨ì„œ ëŠë¦½ë‹ˆë‹¤.
>     
> - ì´ë•ŒÂ `UserService`ë¥¼Â `@Spy`ë¡œ ë§Œë“¤ê³ Â `checkPassword()`ë§ŒÂ `doReturn(true)`ë¡œ ì¡°ì‘í•©ë‹ˆë‹¤.


- ì˜ˆì‹œ ì½”ë“œ (Java + JUnit 5 + Mockito)

ìƒí™©ì€ ì´ë ‡ìŠµë‹ˆë‹¤:

1. **`UserService`ì˜Â `login`Â ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸**í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.
2. `login`Â ì•ˆì—ëŠ”Â **`checkPassword`ë¼ëŠ” ì•„ì£¼ ë¬´ê²ê³  ë³µì¡í•œ ë©”ì„œë“œ**ê°€ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: ì™¸ë¶€ API í˜¸ì¶œ, BCrypt í•´ì‹± ë“±)
3. ìš°ë¦¬ëŠ”Â `login`ì˜ íë¦„(ì„±ê³µ ì‹œ í† í° ë°œê¸‰ ë“±)ë§Œ ë³´ê³  ì‹¶ì§€, ì•”í˜¸í™” ë¡œì§ê¹Œì§€ ê¸°ë‹¤ë¦¬ê³  ì‹¶ì§€ ì•ŠìŠµë‹ˆë‹¤.
4. ê·¸ë˜ì„œÂ **`UserService`Â ì „ì²´ëŠ” ì§„ì§œ(Real)ë¥¼ ì“°ë˜,Â `checkPassword`ë§Œ ê°€ì§œ(Stub)ë¡œ**Â ë§Œë“­ë‹ˆë‹¤.


```java
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Spy;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.doReturn;

// Mockito ê¸°ëŠ¥ì„ ì“°ê¸° ìœ„í•œ í™•ì¥ ë“±ë¡
@ExtendWith(MockitoExtension.class)
class UserServiceTest {

    // 1. @Spy: ì‹¤ì œ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ê°ì‹œ(Spy)í•©ë‹ˆë‹¤.
    @Spy
    private UserService userService;

    @Test
    void loginTest() {
        // Given
        String userId = "testUser";
        String password = "complexPassword";

        // 2. checkPassword ë©”ì„œë“œë§Œ 'true'ë¥¼ ë¦¬í„´í•˜ë„ë¡ ì¡°ì‘ (Stubbing)
        // ì£¼ì˜: Spy ê°ì²´ëŠ” when(...) ëŒ€ì‹  doReturn(...)ì„ ì¨ì•¼ ì‹¤ì œ ë¡œì§ ì‹¤í–‰ì„ ë§‰ì„ ìˆ˜ ìˆìŒ!
        doReturn(true).when(userService).checkPassword(password);

        // When
        // login ë©”ì„œë“œëŠ” 'ì‹¤ì œ ì½”ë“œ'ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
        // í•˜ì§€ë§Œ ë‚´ë¶€ì—ì„œ checkPasswordë¥¼ í˜¸ì¶œí•  ë•Œë§Œ ìœ„ì—ì„œ ì¡°ì‘í•œ ëŒ€ë¡œ trueë¥¼ ë±‰ìŠµë‹ˆë‹¤.
        boolean result = userService.login(userId, password);

        // Then
        assertTrue(result);
    }
}

// í…ŒìŠ¤íŠ¸ ëŒ€ìƒ í´ë˜ìŠ¤ (ì´í•´ë¥¼ ë•ê¸° ìœ„í•œ ê°„ë‹¨ êµ¬í˜„)
class UserService {
    public boolean login(String id, String pw) {
        // ì‹¤ì œ ë¡œì§: ë¹„ë°€ë²ˆí˜¸ ì²´í¬ê°€ ì„±ê³µí•˜ë©´ ë¡œê·¸ì¸ ì„±ê³µ
        if (checkPassword(pw)) {
            System.out.println("ë¡œê·¸ì¸ ë¡œì§ ìˆ˜í–‰: ì„¸ì…˜ ìƒì„± ë“±...");
            return true;
        }
        return false;
    }

    public boolean checkPassword(String pw) {
        // [ë¬¸ì œì˜ êµ¬ê°„]
        // ì‹¤ì œë¡œëŠ” ì—„ì²­ ëŠë¦¬ê±°ë‚˜ ë³µì¡í•œ ì™¸ë¶€ APIë¥¼ ì“´ë‹¤ê³  ê°€ì •
        System.out.println("ì—„ì²­ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì•”í˜¸í™” ë¡œì§ ì‹¤í–‰ ì¤‘... (ì´ê²Œ ì‹¤í–‰ë˜ë©´ ì•ˆ ë¨!)");
        throw new RuntimeException("ì´ê²Œ ì‹¤í–‰ë˜ë©´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"); // í…ŒìŠ¤íŠ¸ í™•ì¸ìš© ì˜ˆì™¸
    }
}
```

-> ìœ„ ì½”ë“œì—ì„œ, ì–´ë–¤ ë¶€ë¶„ì´ JUnit 5 ì˜ ê¸°ëŠ¥ì´ëƒë©´

```java
// [JUnit 5] í…ŒìŠ¤íŠ¸ë¥¼ ì •ì˜í•˜ëŠ” í•µì‹¬ ì–´ë…¸í…Œì´ì…˜
import org.junit.jupiter.api.Test; 
// [JUnit 5] Mockitoì™€ JUnit 5ë¥¼ ì—°ê²°í•´ì£¼ëŠ” ì ‘ì°©ì œ ì—­í• 
import org.junit.jupiter.api.extension.ExtendWith; 

// [Mockito] Spy ê°ì²´ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ì–´ë…¸í…Œì´ì…˜
import org.mockito.Spy; 
// [Mockito] JUnit 5ìš© Mockito í™•ì¥íŒ© (ê¸°ëŠ¥ ì œê³µì)
import org.mockito.junit.jupiter.MockitoExtension; 

// [JUnit 5] ê²€ì¦(Assertion) ë©”ì„œë“œ (ì°¸ì¸ì§€ ê±°ì§“ì¸ì§€ íŒë³„)
import static org.junit.jupiter.api.Assertions.assertTrue; 
// [Mockito] í–‰ë™ ì •ì˜(Stubbing) ë©”ì„œë“œ
import static org.mockito.Mockito.doReturn; 

// [JUnit 5] @ExtendWith: "ë‚˜ ì´ì œë¶€í„° JUnit 5 í…ŒìŠ¤íŠ¸ ëŒë¦´ ê±´ë°, MockitoExtensionì´ë¼ëŠ” ë„êµ¬ë„ ê°™ì´ ì“¸ ê±°ì•¼" ë¼ê³  ì„ ì–¸
@ExtendWith(MockitoExtension.class) 
class UserServiceTest {

    // [Mockito] @Spy: Mockitoê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥. "ì´ ê°ì²´ëŠ” ì§„ì§œ ê°ì²´ì¸ë° ìŠ¤íŒŒì´ì²˜ëŸ¼ ê°ì‹œí•  ê±°ì•¼"
    @Spy
    private UserService userService;

    // [JUnit 5] @Test: "ì´ ë©”ì„œë“œëŠ” í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì•¼" ë¼ê³  JUnitì—ê²Œ ì•Œë ¤ì¤Œ. (JUnit 4ì™€ ì´ë¦„ì€ ê°™ì§€ë§Œ íŒ¨í‚¤ì§€ê°€ ë‹¤ë¦„)
    @Test 
    void loginTest() {
        // ... (ìƒëµ)

        // [Mockito] doReturn: Mockito ê¸°ëŠ¥. "ì´ ë©”ì„œë“œ í˜¸ì¶œë˜ë©´ true ë¦¬í„´í•´"
        doReturn(true).when(userService).checkPassword(password);

        // ... (ìƒëµ)

        // [JUnit 5] assertTrue: JUnit ê¸°ëŠ¥. "ì´ ê²°ê³¼ê°€ trueì—¬ì•¼ í…ŒìŠ¤íŠ¸ í†µê³¼ì•¼" (Mockito ì•„ë‹˜!)
        assertTrue(result); 
    }
}
```

-> `@ExtendWith(MockitoExtension.class)`
ë¥¼ ì“°ëŠ”ë°, ì´ë•Œ `MockitoExtension`  ëŠ” JUnit 5 ê°€ Mockito ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ì—°ê²° ê³ ë¦¬(Extension) ì´ë‹¤.

JUnit 5 ì€ ExtendWith ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ ì™¸ë¶€ ê¸°ëŠ¥ì„ í”ŒëŸ¬ê·¸ì¸ì²˜ëŸ¼ ê°€ì ¸ë‹¤ ì“´ë‹¤.

- `@ExtendWith(MockitoExtension.class)` ì‹œ ë²Œì–´ì§€ëŠ” ì¼ë“¤
-> Mock ê°ì²´ ì´ˆê¸°í™” ìë™í™”: í…ŒìŠ¤íŠ¸ê°€ ì‹œì‘ë  ë•Œ @Mock, @Spy, @InjectMocksê°€ ë¶™ì€ í•„ë“œë¥¼ ì°¾ì•„ì„œ ìë™ìœ¼ë¡œ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ì£¼ì…í•´ì¤ë‹ˆë‹¤. (ì˜ˆì „ JUnit 4ì˜ MockitoAnnotations.initMocks(this)ë¥¼ ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.)

-> ì—„ê²©í•œ Stubbing ê²€ì‚¬ (Strict Stubbing): ë¶ˆí•„ìš”í•œ Stubbing(when ì ˆ)ì´ ìˆìœ¼ë©´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì—¬ ì½”ë“œ í’ˆì§ˆì„ ìœ ì§€í•´ì¤ë‹ˆë‹¤.

-> Parameter Injection ì§€ì›: í…ŒìŠ¤íŠ¸ ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ Mock ê°ì²´ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

###### ì£¼ì˜í•  ì 

@Spy ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤ì œ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. 

- **ìƒí™©:**Â `userRepository.delete()`ë¥¼ ìŠ¤íŒŒì´ë¡œ ê°ì‹œ ì¤‘.
    
- **`when(spy.delete()).thenReturn(...)`Â ì‚¬ìš© ì‹œ:**
    
    - `spy.delete()`ê°€Â **ì‹¤ì œë¡œ ì‹¤í–‰ë¨**. -> DBì—ì„œ ì§„ì§œë¡œ ë°ì´í„°ê°€ ì§€ì›Œì§ (Side Effect).
        
    - ê·¸ í›„ì— ê°’ì„ ë¦¬í„´í•˜ë ¤ê³  í•¨.
        
- **`doReturn(...).when(spy).delete()`Â ì‚¬ìš© ì‹œ:**
    
    - ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³ , "ì´ê±° í˜¸ì¶œë˜ë©´ ì‹¤í–‰í•˜ì§€ ë§ê³  ê·¸ëƒ¥ ë¦¬í„´í•´"ë¼ê³  ë£°ë§Œ ì •í•¨. -> ì•ˆì „í•¨.
        

ê·¸ë˜ì„œÂ **Spy ê°ì²´ë¥¼ ì“¸ ë•ŒëŠ” ë°˜ë“œì‹œÂ `doReturn()`Â íŒ¨í„´ì„ ì¨ì•¼ ì•ˆì „**í•©ë‹ˆë‹¤.



#### **`doReturn(value).when(mock).method()`**

ë©”ì„œë“œë¥¼ ì‹¤ì œë¡œ í˜¸ì¶œí•˜ì§€ ì•Šê³  ê»ë°ê¸°ë§Œ ë³´ê³  ì •ì˜í•¨.
ê·¸ë˜ì„œ @Spy ê°ì²´ë‚˜, void method (doNothing, doThrow) ë“±ì„ ì œì–´í• ë•Œ í•„ìˆ˜ì ìœ¼ë¡œ ì“°ì„

##### Â **Void ë©”ì„œë“œ**Â (`doNothing`,Â `doThrow`Â ë“±)

ë§ˆì°¬ê°€ì§€ë¡œ Mockito ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥.

ë¦¬í„´ê°’ì´ ì—†ëŠ” void ë©”ì„œë“œëŠ” "ê°’ì„ ë¦¬í„´í•´ë¼ (`thenReturn`)" ë¼ëŠ” ëª…ë ¹ì„ ë‚´ë¦´ ìˆ˜ê°€ ì—†ë‹¤.
ê·¸ë˜ì„œ ì•„ë¬´ê²ƒë„ í•˜ì§€ë§ˆë¼, ì˜ˆì™¸ë¥¼ ë˜ì ¸ë¼ ê°™ì€ ëª…ë ¹ì–´ê°€ ë”°ë¡œ ì¡´ì¬í•˜ëŠ” ê²ƒ.

- `doNothing`
	**ì˜ë¯¸:**Â "ì´ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´ ì•„ë¬´ ì¼ë„ í•˜ì§€ ë§ˆ."	    
	**ìš©ë„:**Â ì£¼ë¡œÂ `void`Â ë©”ì„œë“œë¥¼ ê°€ì§„Â **Spy ê°ì²´**ì—ì„œ íŠ¹ì • ë™ì‘ì„ ë„ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. (Mock ê°ì²´ì˜ void ë©”ì„œë“œëŠ” ì–´ì°¨í”¼ ì•„ë¬´ ì¼ë„ ì•ˆ í•˜ë¯€ë¡œ ì“¸ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.)

```java
// ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ ë©”ì„œë“œ(sendEmail)ëŠ” ì‹¤í–‰í•˜ì§€ ë§ê³  ë„˜ì–´ê°€ë¼
Mockito.doNothing().when(emailService).sendEmail(any());
```

- `doThrow`
	ì˜ë¯¸: "ì´ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´ ì—ëŸ¬(Exception)ë¥¼ í„°ëœ¨ë ¤."
	ìš©ë„: ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì˜ ë˜ì–´ ìˆëŠ”ì§€(íŠ¸ëœì­ì…˜ ë¡¤ë°± ë“±) í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. void ë©”ì„œë“œë¿ë§Œ ì•„ë‹ˆë¼ ë¦¬í„´ê°’ì´ ìˆëŠ” ë©”ì„œë“œì—ë„ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
// ì‚­ì œ ë©”ì„œë“œ í˜¸ì¶œ ì‹œ RuntimeException ë°œìƒ ì‹œí‚¤ê¸°
Mockito.doThrow(new RuntimeException("DB Error")).when(repository).deleteById(any());
```


### when() ì¡°ê±´ì— ë¶€í•©í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë¬´ì—‡ì„ ë¦¬í„´í•˜ëŠ”ê°€ ? (Unstubbed Invocation)

ê¸°ë³¸ì ìœ¼ë¡œ `null` ì„ ë°˜í™˜í•œë‹¤.
ì—ëŸ¬ë¥¼ ë±‰ì§€ ì•Šê³ , ë¬´ë‚œí•œ ê¸°ë³¸ê°’ì„ ë˜ì§„ë‹¤.

- ê°ì²´ì˜ ê²½ìš° : null
- ê¸°ë³¸í˜• ìˆ«ì : 0
- Boolean : false
- Optional : Optional.empty()
- Collections (List, Map) : Empty List, Empty map (ìµœì‹  Mockito ë²„ì „ì—ëŠ” null ëŒ€ì‹  empty list, map ë“±ì„ ì¤€ë‹¤ê³ .)



## @InjectMocks

**"ê·¸ëŸ¼Â `@Mock`ìœ¼ë¡œ ë§Œë“  ê°€ì§œ ê°ì²´ì™€Â `@Spy`ë¡œ ë§Œë“  ìŠ¤íŒŒì´ ê°ì²´ë¥¼, ë‚´ê°€ í…ŒìŠ¤íŠ¸í•˜ë ¤ëŠ” ì§„ì§œ ì„œë¹„ìŠ¤(`@Service`)ì— ì–´ë–»ê²Œ ì§‘ì–´ë„£ì§€?"**
-> ì˜ì¡´ì„±ì„ ì–˜ê¸°í•˜ëŠ” ê²ƒì´ë‹¤.

```java
public class UserService {
    // UserServiceëŠ” UserRepositoryê°€ ì—†ìœ¼ë©´ ì¼ì„ ëª» í•´ìš”!
    private UserRepository userRepository; 

    // ìƒì„±ì (Constructor)
    public UserService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
    
    public void signUp() {
        // ... ë¡œì§ ...
        userRepository.save(user); // ì—¬ê¸°ì„œ ë°”í€´ë¥¼ ì‚¬ìš©í•¨!
    }
}
```

Userservice ê°€ ë™ì‘í•˜ë ¤ë©´ ì˜ì¡´ì„± UserRepository ê°€ ë°˜ë“œì‹œ í•„ìš”í•˜ë‹¤.
í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ UserRepository ë¥¼ @Mock ê°ì²´ë¡œ ë§Œë“¤ì–´ë²„ë¦¬ë©´

```java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {

    @Mock
    UserRepository fakeRepository; // ê°€ì§œ ë°”í€´ ìƒì„± (Mockitoê°€ ë§Œë“¤ì–´ì¤Œ)

    // ??? ì§ˆë¬¸: ì´ ê°€ì§œ ë°”í€´ë¥¼ ìë™ì°¨ì— ì–´ë–»ê²Œ ë¼ìš°ì§€?
    UserService userService; 
    
    @Test
    void test() {
        // ë°©ë²• 1: ì§ì ‘ ì†ìœ¼ë¡œ ë¼ìš´ë‹¤ (ìˆ˜ë™)
        userService = new UserService(fakeRepository); 
        userService.signUp();
    }
}
```

ì €ë ‡ê²Œ ì¼ì¼íˆ í•´ì£¼ì–´ì•¼ í•˜ëŠ”ë°, @InjectMock ì„ ì“°ë©´

```java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {

    @Mock
    UserRepository fakeRepository; // ê°€ì§œ ë°”í€´ (ë¶€í’ˆ)

    @InjectMocks // <--- ì´ê²Œ ë§ˆë²•!
    UserService userService; // ì™„ì„±í’ˆ (ìë™ì°¨)

    @Test
    void test() {
        // new UserService(fakeRepository) ë¼ê³  ì•ˆ ì¨ë„ ë¨!
        // @InjectMocksê°€ ì•Œì•„ì„œ fakeRepositoryë¥¼ userService ì•ˆì— ì™ ë„£ì–´ì¤Œ.
        userService.signUp(); 
    }
}
```

ì´ ê°€ëŠ¥í•´ì§„ë‹¤.

ì¦‰, í…ŒìŠ¤íŠ¸í•˜ê³ ì í•˜ëŠ” ì„œë¹„ìŠ¤ì˜ ì˜ì¡´ì„±ì„ Mock ê°ì²´ë¡œ ì‚¬ìš©í• ë•Œ, ê·¸ ì„œë¹„ìŠ¤ì˜ Mock ê°ì²´ ì˜ì¡´ì„±ì„ ì£¼ì…í•´ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì„ ì˜ë¯¸í•œë‹¤.


## í…ŒìŠ¤íŠ¸ ê´€ë ¨ ìš”ì•½


### 1. JUnit 5 (í…ŒìŠ¤íŠ¸ ì‹¤í–‰ê¸°)

- **`@Test`**: "ì´ê±° í…ŒìŠ¤íŠ¸ í•  ê±°ì•¼!"ë¼ê³  ë¶™ì´ëŠ” ë”±ì§€.
    
- **`@ExtendWith(MockitoExtension.class)`**: "ë‚˜ Mockito(ê°€ì§œ ê°ì²´) ì“¸ ê±°ë‹ˆê¹Œ ì¤€ë¹„í•´ì¤˜!" (ìŠ¤ë§ˆíŠ¸í°ì— ì•± ì„¤ì¹˜)
    

### 2. Mockito (ê°€ì§œ ê°ì²´ ê³µì¥)

- **`@Mock`**:Â **"ê°€ì§œ ë¶€í’ˆ"**Â (ì˜ˆ:Â `UserRepository`). ê»ë°ê¸°ë§Œ ìˆëŠ” ê°€ì§œì…ë‹ˆë‹¤.
    
- **`@InjectMocks`**:Â **"ì§„ì§œ ë³¸ì²´"**Â (ì˜ˆ:Â `UserService`). ì—¬ê¸°ì—Â `@Mock`ìœ¼ë¡œ ë§Œë“  ê°€ì§œ ë¶€í’ˆë“¤ì„Â **ìë™ìœ¼ë¡œ ì¡°ë¦½**í•´ì¤ë‹ˆë‹¤.
    

### 3. AssertJ (ê²€ì¦ ë„êµ¬)

- **`assertThat(...)`**: í…ŒìŠ¤íŠ¸ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•  ë•Œ ì”ë‹ˆë‹¤. "ì´ê²Œ ì´ê±°ë‘ ê°™ì•„ì•¼ í•´!"ë¼ê³  ë”°ì§€ëŠ” ì—­í• ì…ë‹ˆë‹¤.

