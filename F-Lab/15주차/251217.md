

## ResponseEntityExceptionHandler

ì§€ê¸ˆ ë‚´ê°€ ë§Œë“œë ¤ëŠ” ì½”ë“œ
```java
@ExceptionHandler(UserNotFoundException.class)  
public ResponseEntity<ProblemDetail> handleWithProblemDetail(UserNotFoundException ex, HttpServletRequest request) {  
    ex.getProblemDetail().setInstance(URI.create(request.getRequestURI()));  
  
    return ResponseEntity.status(ex.getHttpStatus()).body(ex.getProblemDetail());  
}
```

ì—ì„œ 

```java
ex.getProblemDetail().setInstance(URI.create(request.getRequestURI()));  
```
ì´ ë¶€ë¶„ì´ ë‹¤ë¥¸ Exception Handler ì—ì„œ ì¤‘ë³µì´ ë í…ë°, ì´ê±¸ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ
ResponseEntityExceptionHandler ë¥¼ ì“¸ ìˆ˜ ìˆë‹¤.


### ì»¤ìŠ¤í…€ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ì—ì„œ ì¤‘ë³µë˜ëŠ” ì½”ë“œëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ê°€ ? -> ì˜ˆì™¸ì²˜ë¦¬ íë¦„ì— ëŒ€í•œ ì´í•´

#### ê¸°ì¡´ì— ì¡´ì¬í•˜ë˜ Exception ì²˜ë¦¬ íë¦„

ê°€ë ¹ `MethodArgumentNotValidException` ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆë‹¤ê³  ê°€ì •í•˜ì.

```java
@RestControllerAdvice  
public class GlobalExceptionHandler extends ResponseEntityExceptionHandler {
	...
}
```
ë‚´ê°€ ì´ëŸ°ì‹ìœ¼ë¡œ ê¸€ë¡œë²Œ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ë¥¼ ì§€ì •í–ˆì„ë•Œ

1. ë¨¼ì € GlobalExceptionHandler ë¥¼ ì°¾ì•„ì˜¨ë‹¤.
2. í•´ë‹¹ ìµì…‰ì…˜ì— ëŒ€í•œ í•¸ë“¤ëŸ¬ê°€ ì—†ì„ ê²½ìš° ResponseEntityExceptionHandler ì˜ ê²ƒì„ ì“°ëŸ¬ê°„ë‹¤.
3. ResponseEntityExceptionHandler ì˜ **`handleException()`** 
   `@ExceptionHandler({ ... })`ê°€ ë•ì§€ë•ì§€ ë¶™ì–´ ìˆì–´ì„œ, ì‚¬ì‹¤ìƒÂ **ëª¨ë“  í‘œì¤€ ì˜ˆì™¸ì˜ ì…êµ¬**
	   -  "ì–´?Â `MethodArgumentNotValidException`ì´ë„¤? ë„Œ 3ë²ˆ ì°½êµ¬ë¡œ ê°€ë¼."
    - "ì–´?Â `HttpRequestMethodNotSupportedException`ì´ë„¤? ë„Œ 4ë²ˆ ì°½êµ¬ë¡œ ê°€ë¼."
	â¬‡ï¸ (ë‚´ë¶€ ë¶„ê¸° ì²˜ë¦¬)
4. ë‚´ë¶€ ë¶„ê¸° ì²˜ë¦¬ì— ë”°ë¼ ResponseEntityExceptionHandler ì˜ **`handleMethodArgumentNotValid`** ê°€ ì‹¤í–‰ë¨

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ResponseEntityExceptionHandler ë¥¼ ìƒì†í•œ GlobalExceptionHandler ê°€ 
handleMethodArgumentNotValid ë¥¼ override í•œ ê²½ìš°, override í•œ ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ê³ ,
ì´ ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ê³  ë‚˜ë©´ ë‹¤ì‹œ ResponseEntityExceptionHandler ì˜ ë‚´ë¶€ íë¦„ìœ¼ë¡œ ëŒì•„ê°„ë‹¤

ê·¸ë¦¬ê³  ResponseEntityExceptionHandler ì˜ ë‚´ë¶€íë¦„ì´ ëë‚˜ê³  ë‚œ ë§ˆì§€ë§‰ íë¦„ì´ **handleExceptionInternal** ì´ë‹¤.

```java
@Nullable  
protected ResponseEntity<Object> handleMethodArgumentNotValid(  
       MethodArgumentNotValidException ex, HttpHeaders headers, HttpStatusCode status, WebRequest request) {  
  
    return handleExceptionInternal(ex, null, headers, status, request);  
}
```

```java
@Nullable  
protected ResponseEntity<Object> handleExceptionInternal(  
       Exception ex, @Nullable Object body, HttpHeaders headers, HttpStatusCode statusCode, WebRequest request) {  
  
    ...
  
    return createResponseEntity(body, headers, statusCode, request);  
}

protected ResponseEntity<Object> createResponseEntity(  
       @Nullable Object body, HttpHeaders headers, HttpStatusCode statusCode, WebRequest request) {  
  
    return new ResponseEntity<>(body, headers, statusCode);  
}
```



#### Custom Exception

ìš°ë¦¬ê°€ ì •ì˜í•œ Exception ì€ ResponseEntityExceptionHandler ì˜ **`handleException()`**  ë„ ê±°ì¹˜ì§€ ì•ŠëŠ”ë‹¤.

```java
// ë¶€ëª¨ í´ë˜ìŠ¤ (ìŠ¤í”„ë§ ì½”ë“œ)
@ExceptionHandler({
    HttpRequestMethodNotSupportedException.class,
    HttpMediaTypeNotSupportedException.class,
    MethodArgumentNotValidException.class,
    // ... (í‘œì¤€ ì˜ˆì™¸ ì‹­ìˆ˜ ê°œ ë‚˜ì—´) ...
})
public final ResponseEntity<Object> handleException(Exception ex, WebRequest request) { 

...

  
	else if (ex instanceof AsyncRequestNotUsableException theEx) {  
	    return handleAsyncRequestNotUsableException(theEx, request);  
	}  
	else {  
	    // Unknown exception, typically a wrapper with a common MVC exception as cause  
	    // (since @ExceptionHandler type declarations also match nested causes):    
	    // We only deal with top-level MVC exceptions here, so let's rethrow the given    
	    // exception for further processing through the HandlerExceptionResolver chain.    
	    throw ex;  
	} 
}

```

ResponseEntityExceptionHandler ì˜ **`handleException()`** ì´ ê·¸ëƒ¥ ë˜ì ¸ë²„ë¦°ë‹¤.

1. **Case A (í•¸ë“¤ëŸ¬ë¥¼ ì•ˆ ë§Œë“¤ì—ˆì„ ë•Œ)**:
        
 ì•„ë¬´ë„ ì²˜ë¦¬ ì•ˆ í•¨ -> ë°–ìœ¼ë¡œ íŠ•ê²¨ ë‚˜ê° -> ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ê¸°ë³¸Â `BasicErrorController`Â (`/error`Â ê²½ë¡œ)ê°€ ë°›ì•„ì„œ ì²˜ë¦¬ (Whitelabel Error Pageë‚˜ ê¸°ë³¸ JSON ì‘ë‹µ).
            
2. **Case B (ìë„¤ê°€Â `@ExceptionHandler(CustomException.class)`ë¥¼ ë§Œë“¤ì—ˆì„ ë•Œ)**:
	
  "ì˜¤! ìë„¤(ìì‹ í´ë˜ìŠ¤)ê°€ ì²˜ë¦¬í•œë‹¤ê³  ì¨ë†¨ë„¤!" ->Â **ë°”ë¡œ ë‚´ê°€ ë§Œë“  ë©”ì„œë“œ ì‹¤í–‰.**Â (ë¶€ëª¨ëŠ” ì•„ì˜ˆ ê°œì… ì•ˆ í•¨)


#### Return Type ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” ë¶„ê¸°

ê·¸ë˜ì„œ ë‚´ê°€ ë§Œë“  Custom Exception Hanlder ì—ì„œ 
ê·¸ëƒ¥ ê°ì²´ë¥¼ ë¦¬í„´í•˜ë©´ ê·¸ê±´ ResponseEntity.ok(ê°ì²´) ê°€ ëœë‹¤. (HttpStatus.OK - 200)

ê·¼ë° ë§Œì•½ì— ê·¸ í•¸ë“¤ëŸ¬ì—ì„œ `handleExceptionInternal` ì„ ë¦¬í„´í•˜ë©´,

ResponseEntityExceptionHandler ì˜ ë‚´ë¶€ í•„ë“œ `handleExceptionInternal` ì„ ê±°ì³ê°€ê²Œ ë˜ê³ 

ì´ handleExceptionInternal ì€ ê¸°ì¡´ì— ì •ì˜ë˜ì–´ìˆë˜ ë‹¤ë¥¸ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ë„ ë§ˆì§€ë§‰ì— ê±°ì³ê°€ëŠ” ê³³ì´ë©°

ì´ê³³ì„ ê±´ë“œë¦¬ê²Œ ë¨ìœ¼ë¡œì¨ ëª¨ë“  ìµì…‰ì…˜ì˜ ìµœì¢…ë‹¨ê³„ì—ì„œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.



#### ê·¸ë ‡ë‹¤ë©´, handleExceptionInternal ì—ì„œ ë¦¬í”Œë ‰ì…˜ìœ¼ë¡œ ì»¤ìŠ¤í…€ìµì…‰ì…˜ì˜ getProblemdetail ì´ ìˆëŠ”ì§€ íŒë‹¨í•˜ë©´ ë˜ëŠ”ê±´ê°€?

ì™œëƒí•˜ë©´ ê¸°ì¡´ Exception ë“¤ì€ getProblemDetail ì´ ì—†ì„ ê²ƒì´ê³ , 
ë‚´ê°€ ë§Œë“  CustomException ì€ ProblemDetail ì˜ ë©”ì‹œì§€ë¥¼ ì»¤ìŠ¤í…€ìœ¼ë¡œ ë§Œë“¤ë ¤ê³  í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ê·¸ëŸ°ë° ë¦¬í”Œë ‰ì…˜ì€ ë¹„ìš©ì´ ë„ˆë¬´ ë§ì´ ë“ ë‹¤.
ê·¸ë¦¬ê³  ì»´íŒŒì¼ íƒ€ì„ì— ì¡ì„ ìˆ˜ ìˆëŠ” ì—ëŸ¬ë¥¼ ëŸ°íƒ€ì„ìœ¼ë¡œ ë„˜ê¸°ëŠ” ê²ƒì´ë‹¤ (ì˜¤íƒ€ë¡œ getProblemDetail ì´ ì—†ìœ¼ë©´ ì–´ì©Œë ¤ê³  ?)

Spring Boot 3 ì—ì„œëŠ” ErrorResponse ë¼ëŠ” ë°©ë²•ì´ ìˆë‹¤.


```java
import org.springframework.web.ErrorResponse;
// ... imports

@Getter
public class UserNotFoundException extends RuntimeException implements ErrorResponse { // ğŸ‘ˆ ì´ê²ƒë§Œ ì¶”ê°€í•˜ê²Œ!
    private final String loginId;
    private final HttpStatus httpStatus;

    public UserNotFoundException(String loginId) {
        super("ì‚¬ìš©ì ì¡°íšŒ ì•ˆë¨ - login Id : " + loginId);
        this.loginId = loginId;
        this.httpStatus = HttpStatus.NOT_FOUND;
    }

    @Override
    public HttpStatusCode getStatusCode() {
        return httpStatus;
    }

    @Override
    public ProblemDetail getBody() {
        // ìë„¤ê°€ ì›í•˜ë˜ ë°”ë¡œ ê·¸ ì»¤ìŠ¤í…€ ë¡œì§!
        ProblemDetail detail = ProblemDetail.forStatusAndDetail(httpStatus, getMessage());
        detail.setTitle("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì");
        detail.setProperty("loginId", loginId); // detailì— ì»¤ìŠ¤í…€ í•„ë“œ ì¶”ê°€
        return detail;
    }
}
```

ì´ë ‡ê²Œ í•˜ë©´ GlobalExceptionHandler ì—ëŠ” ì•„ë¬´ê²ƒë„ ì•ˆí•´ë„ ëœë‹¤.

ì™œëƒí•˜ë©´
`UserNotFoundException`ì´ í„°ì§€ë©´:

1. `ResponseEntityExceptionHandler`ê°€ ì˜ˆì™¸ë¥¼ ì¡ìŒ.
2. "ì–´? ë„ˆÂ `ErrorResponse`Â ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„í–ˆë„¤?" í™•ì¸.
3. `getBody()`ë¥¼ í˜¸ì¶œí•´ì„œ ìë„¤ê°€ ë§Œë“ Â `ProblemDetail`ì„ ê°€ì ¸ê°.
4. `handleExceptionInternal`ì„ íƒœì›Œì„œ ì‘ë‹µ ë‚´ë³´ëƒ„.

ResponseEntityExceptionHandler ì˜ handleExceptionInternal ì— ì• ì´ˆì— ì´ë¯¸
	
```java
@Nullable  
protected ResponseEntity<Object> handleExceptionInternal(  
       Exception ex, @Nullable Object body, HttpHeaders headers, HttpStatusCode statusCode, WebRequest request) {  
  
    if (request instanceof ServletWebRequest servletWebRequest) {  
       HttpServletResponse response = servletWebRequest.getResponse();  
       if (response != null && response.isCommitted()) {  
          if (logger.isWarnEnabled()) {  
             logger.warn("Response already committed. Ignoring: " + ex);  
          }  
          return null;  
       }  
    }  
  
    if (body == null && ex instanceof ErrorResponse errorResponse) {  
       body = errorResponse.updateAndGetBody(this.messageSource, LocaleContextHolder.getLocale());  
    }  
  
    if (statusCode.equals(HttpStatus.INTERNAL_SERVER_ERROR) && body == null) {  
       request.setAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE, ex, WebRequest.SCOPE_REQUEST);  
    }  
  
    return createResponseEntity(body, headers, statusCode, request);  
}
```

ì¼ë‹¨ ë‹¤ì‹œí•œë²ˆ íë¦„ì„ ìƒê°í•´ë³´ë©´

CustomException ì—ì„œëŠ” ResponseEntityExceptionHandler ì˜ handleException ì˜ else ë¬¸ìœ¼ë¡œ ë¹ ì§„ë‹¤.
ì¦‰ throw ex ë¡œ ê°„ë‹¤.

ì´ ë˜ì ¸ì§„ ex ëŠ” 

1. **`DispatcherServlet`ìœ¼ë¡œ ë˜ëŒì•„ê°. (í˜¸ì¶œ ìŠ¤íƒì„ íƒ€ê³  ì˜¬ë¼ê°)
2. `DispatcherServlet`ì€ "ì–´? ì²« ë²ˆì§¸ í•¸ë“¤ëŸ¬(`handleException`)ê°€ ì²˜ë¦¬ë¥¼ ëª» í•˜ê³  ë‹¤ì‹œ ë˜ì¡Œë„¤?" í•˜ê³ Â **ë‹¤ìŒ ë‹¨ê³„**ë¥¼ ì°¾ìŒ.    
3. **ë‹¤ìŒ ë‹¨ê³„ë€?**
    
    - ë§Œì•½ ìë„¤ê°€Â `@ExceptionHandler(RuntimeException.class)`Â ê°™ì€ **"í¬ê´„ì ì¸ í•¸ë“¤ëŸ¬"ë¥¼ ë§Œë“¤ì–´ë’€ë‹¤ë©´? ->Â ê±°ê¸°ë¡œ ë‹¤ì‹œ ë“¤ì–´ê°.**
    - ë§Œì•½ ì•„ë¬´ í•¸ë“¤ëŸ¬ë„ ì—†ë‹¤ë©´? -> **`BasicErrorController`Â (`/error`)ë¡œ ë„˜ì–´ê° (Whitelabel Error Page í˜¹ì€ ê¸°ë³¸ JSON ì‘ë‹µ).
        
ê·¸ëŸ¬ë‹ˆê¹Œ  ì´ëŸ°ì‹ìœ¼ë¡œ ì¡ì•„ì£¼ë©´ ëœë‹¤.

```java
@RestControllerAdvice  
public class GlobalExceptionHandler extends ResponseEntityExceptionHandler {  
  
    @ExceptionHandler(RuntimeException.class)  
    public ResponseEntity<Object> customExceptionHandler(Exception ex, @Nullable Object body, HttpHeaders headers,  
       HttpStatusCode statusCode, WebRequest request) {  
  
       if (ex instanceof ErrorResponse errorResponse) {  
          return handleExceptionInternal(  
             ex,  
             errorResponse.getBody(),  
             errorResponse.getHeaders(),  
             errorResponse.getStatusCode(),  
             request  
          );  
       }  
  
       return super.handleExceptionInternal(ex, body, headers, statusCode, request);  
    }  
}
```

throw ex ì‹œ customExceptionHandler ë¡œ ë“¤ì–´ê°€ê²Œ ë˜ëŠ” ê²ƒì´ë‹¤. ì™œëƒí•˜ë©´ ìš°ë¦¬ì˜ customException ì€ runtimeException ì„ ìƒì†ë°›ì•˜ê¸° ë•Œë¬¸ì—.

ê·¸ëŸ¼ ì´ì œ ìš°ë¦¬ì˜ ì»¤ìŠ¤í…€ ìµì…‰ì…˜ì— ErrorResponse ë¥¼ implement í•˜ë©´ ë˜ëŠ”ë°...


#### ErrorResponse

ê·¸ëŸ°ë° ErrorResponse ë¥¼ êµ¬í˜„í• ë¼ ì¹˜ë©´ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

![[Screenshot 2025-12-18 at 12.16.33 AM.png|800]]

ì´ëŠ” Spring Boot 3 ë¶€í„° ì‹œì‘ëœ ì—„ê²©í•œ null  ì²˜ë¦¬ ê·œì¹™ ë•Œë¬¸ì´ë‹¤.

ìŠ¤í”„ë§ íŒ€ì´ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ 6 ë‚´ë¶€ì˜ ê±°ì˜ ëª¨ë“  íŒ¨í‚¤ì§€ì— @NonNullApi ë¥¼ í•´ë†“ì•˜ë‹¤.

ê·¸ëŸ°ë° ë‚´ê°€ getStatusCode ë¥¼ ì˜¤ë²„ë¼ì´ë”© í•˜ë©´ì„œ null ì¼ìˆ˜ë„ ìˆê³  ì•„ë‹ìˆ˜ë„ ìˆë‹¤ê³  (ê¸°ë³¸ìƒíƒœ) ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸.
ë¶€ëª¨(`ErrorResponse`)ëŠ” "ë‚´ ìì‹ì€ ë¬´ì¡°ê±´ Nullì´ ì•„ë‹ŒÂ `HttpStatusCode`ë¥¼ ë‚´ë†”ì•¼ í•´!"ë¼ê³  ì•½ì†í–ˆëŠ”ë°, ìë„¤ê°€ ê·¸ ì•½ì†ì„ ëª…ì‹œì ìœ¼ë¡œ ì•ˆ ì§€í‚¨ ê¼´ì´ì§€.

->  âœ… í•´ê²°ì±…:Â `@NonNull`Â ì–´ë…¸í…Œì´ì…˜ ë¶™ì´ê¸°

ê·¸ëƒ¥ ë©”ì„œë“œ ìœ„ì— **`@NonNull`ì„ ë¶™ì—¬ì„œ "ê±±ì • ë§ˆ, ì ˆëŒ€ null ì•ˆ ë¦¬í„´í•´!"ë¼ê³  ì„ ì–¸í•´ì£¼ë©´ í•´ê²°ë˜ë„¤.