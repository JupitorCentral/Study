

## Thread vs Process 또 어제에 이어서



#### "동시성"과 "병렬성"의 차이를 어떻게 설명할 수 있을까?

동시성 (concurrency) 는 한개 또는 여러개의 코어에 대해서 각각의 코어가 여러개의 쓰레드를 CPU scheduling algorithm 을 통해
얼마나 각 쓰레드에 시간을 쏟을지를 결정하여 여러개의 쓰레드의 코드를 나누어서 실행하는 것을 의미하며,
여러개의 쓰레드를 빠른 속도로 나누어서 실행하기 때문에 겉으로봤을때는 여러개의 코어가 여러개의 쓰레드를 실행하는 것 처럼 보임,

동시성은 어떤 작업을 다루는 방식으로도 생각할 수 있다.
여러 작업이 실제로 실행되지는 않아도, '실행 중' 인 상태로 관리하는 것이다.

설계의 관점에서 봤을때, 여러개의 쓰레드들을 어떻게 구조화하여 여러 작업을 동시에 다루게 것인가에 대한 문제이다.
대표적으로 웹서버가 여러 요청을 동시에 처리할 수 있게 설계하는 것이다.

동시성은 여러작업을 동시에 다루는 구조(설계).


병렬성의 경우 물리적으로 여러개의 코어가 여러개의 쓰레드를 동시에 실행하는 것을 의미함.
즉 여러개의 물리적 코어가 실행되는 것을 의미함.
병렬성과 동시성이 공존할 수 있음 - 여러개의 코어에 대해서 각각의 코어가 여러개의 쓰레드를 실행할 수 있음.

병렬성의 경우 여러 작업이 실제로 실행되는 것을 의미. 실제로 여러 작업이 동시에 실행되는가에 대한 문제.
예를 들어, 4개의 코어가 4개의 요청을 동시에 처리하는 것.


요리에 비유하자면 동시성은 여러개의 요리를 요리사가 조금씩 나누어서 번갈아가면서 요리하는것
병렬성은 여러명이 요리사가 요리를 하는 것.


#### 프로세스간 동시성, 병렬성이란 ?

프로세스간의 동시성이라 함은 여러 개의 프로세스가 동시에 실행되는 것처럼 관리되어 나누어서 실행되는 상황을 의미함.
각각의 프로세스가 얼마동안 실행될지를 결정하기 위해 CPU scheduling algorithm 이 필요함.

프로세스간의 병렬성이라 함은 여러개의 물리적코어가 각각의 프로세스를 실행하는 상황을 의미함.


#### "프로세스와 스레드의 메모리 구조 차이"가 동시성/병렬성에 어떤 영향을 미칠까?



- "프로세스는 메모리를 공유하지 않으니, 프로세스 간 동시성/병렬성 구현 시 어떤 제약이 있을까?"

> 이때, 프로세스 간 동시성/병렬성을 구현할때 생기는 제약/필요조건은, 동시성을 위한 제약조건과 병렬성을 위한 제약조건은
> 사실상 같다. 그 둘을 구현하기 위해서는 둘 다 서로 다른 스레드를 같은 시간상 시점에서 실행되어야 하기 때문이다.

> 프로세스 간 동시성/병렬성을 구현한다는 말은 무슨 의미인가 ?
> -> 여러 프로세스가 동시에 실행 (병렬적으로 또는 동시적으로) 될 수 있도록 시스템을 설계하고 운영하는 것을 의미함.
> 그렇게 시스템을 설계하고 운영하기 위해서는 그 과정에서 일어나는 문제를 해결해야 함을 내포함.


프로세스는 프로세스끼리 메모리를 공유하지 않는다.
하지만 프로세스가 동시적/병렬적으로 실행하는 데에 있어서 프로세스간 협업이 필요한 순간이 있다.
이를 위해서는 프로세스가 서로 소통해야 하며, 이 때의 메모리 공유를 위해 운영체제의 개입이 필요하다.
운영체제의 개입이 필요하며, 파이프, 소켓, 공유 메모리 등의 운영체제가 제공하는 수단을 통해 IPC 를 달성해야 한다. (IPC 가 필요하다.)


- "스레드는 메모리를 공유하니, 동시성/병렬성 구현 시 어떤 문제가 생길까? (예: 데이터 경합, race condition, 락 필요성 등)"



프로세스와 스레드에 대해서 동시성/병렬성 구현시 생기는 문제는 각각의 자원 공유의 대상,범위의 차이에 있다.

#### 프로세스와 스레드의 자원 공유의 차이

-> 동기화 문제와 밀접한 관련이 있음

##### 프로세스

기본적으로 메모리 공유가 안되지만, 운영체제가 허락하는 한에서 '공유 메모리' 가 있음.
그리고 Computer 의 자원 - 각종 파일, I/O device 등을 공유한다.

> [!info] 파일과 I/O 의 차이
>  파일은 OS 가 제공하는 논리적인 저장 단위. 데이터를 저장하고 읽고 쓰는데에 쓰임.
>  I/O 는 컴퓨터 시스템에서 데이터를 주고 받는 모든 작업을 의미함. 파일 뿐만 아니라 네트워크, 프린터 등 다양한 장치와의 데이터 교환을 포함함.

##### 스레드
속해 있는 프로세스 내의 code, Data - 전역 변수, 힙 영역 등, 
File discripter - 프로세스가 연 파일, 소켓 등 , I/O device - 프로세스가 접근하는 I/O 자원, 등



#### 프로세스의 스레드의 목적의 차이

프로세스는 '무엇을 할 것인가' 에 중점을 두며 이에 따라 작업의 정의, 그리고 그 작업을 하기 위한 자원 확보에 중점이 있다.

스레드의 목적은 하나의 프로세스 내에서 여러 작업을 동시에 처리하기 위한 수단임.


>[!info] 프로세스를 실행한다는 것은
> 운영체제가 그 프로그램의 코드를 메모리에 적재하고, 하나 이상의 프로세스를 생성하며, 
> 그 프로세스의 **하나 이상의 스레드**가 실제로 명령어를 실행하는 것을 의미.


> [!Question] 하나 이상의 프로세스를 실행하는 이유
> 운영체제는 하나의 프로그램을 여러개의 프로세스를 실행할 수 있음 - 예를 들어, 서러 프로그램이 여러개의 요청을 처리할때.
> 그 이유는 자원 격리, 보안 및 안정성, 다중 사용자/다중 작업환경, 존재할 수 있는 서로다른 환경 때문임. 
> (프로세스는 서로 다른 설정에 따라 다른 작업을 목표로 하기 때문임)




### Process vs Thread - in terms of Unit



프로세스와 스레드의 역할 분담은 **오버헤드(Overhead) 절감**과 **효율적인 병렬 처리**를 가능하게 한다..

| 특징             | 프로세스 (Process, 작업의 단위)                              | 스레드 (Thread, 실행의 단위)                                          |
| :------------- | :-------------------------------------------------- | :------------------------------------------------------------ |
| **자원 소유**      | **자원의 소유자** (메모리, 파일, I/O 장치 등)                     | **자원의 공유자** (프로세스가 가진 자원을 공유)                                 |
| **생성 및 관리 비용** | **비용이 많이 든다 (Heavyweight)**<br>: 메모리 및 자원 할당이 수반됨,. | **비용이 적게 든다 (Lightweight)**: <br>이미 프로세스가 확보한 자원을 공유하므로 경제적임. |
| **스위칭 비용**     | **컨텍스트 스위치 비용이 높다**.                                | **컨텍스트 스위치 비용이 낮다** (프로세스보다 약 5배 빠름).                         |
| **독립성/보호**     | **높은 독립성.** 독립적인 주소 공간으로 강력한 보호 제공.                 | **낮은 독립성.** 공유 메모리로 인해 동기화(Synchronization) 필요.               |
| **목표**         | 전체 작업을 정의하고, 리소스를 확보하며, **보호**를 제공함.                | 확보된 리소스 내에서 명령어 실행을 담당하여 **CPU 활용** 및 **병렬성**을 높임.            |



---


#### "구현 관점에서, 프로세스와 스레드의 선택 기준은 무엇일까?"

##### "왜 어떤 상황에서는 프로세스를, 어떤 상황에서는 스레드를 쓰는 게 더 적합할까?"
	
###### 어떤 상황에서 프로세스를 쓰는 게 더 적합할까?

브라우저의 경우, 하나의 탭의 종료가 다른 탭에 영향을 가지 않아야 하기 때문에
이럴때는 독립적인 실행환경이 보장되는 프로세스가 더 적합하게 쓰인다.

데이터 베이스의 경우, 각 클라이언트의 연결을 별도의 프로세스로 관리하여,
하나의 연결에서 발생하는 오류가 전체 데이터베이스의 실행에 영향을 끼치지 못하게 함.

보안이 중요한 서비스의 경우, 서로 다른 사용자 세션을 분리하여 메모리를 공유하지 못하게 함으로써
한 세션이 다른 사용자의 중요한 정보를 취득하지 못하게 함.

###### 어떤 상황에서 스레드를 쓰는 게 더 적합할까?

웹 서버 (Apache Tomcat 등) 가 그 예시로 들 수 있다.

웹 서버가 요청을 처리하는데에 필요한 주요 자원들로는

- 네트워크 소켓

- 메모리 (버퍼, 캐시 등)

- 파일 핸들

- DB 커넥션

- 로그 기록

이 있으며, 이들 자원은 하나의 프로세스에서 여러 스레드들이 공유가 가능한 자원들이다.
즉 처리에 필요한 실행 단위는 스레드로 충분하며, 심지어 스레드의 생성에는 프로세스보다
자원이 훨씬 덜 들기 떄문에 스레드가 더 유리함.


##### 상황을 나눠서 생각해 볼 수 있는 기준

###### 자원 격리가 필요한가 ?
I/O 차원에서는 운영체제의 커널을 통해 공유되지만, 메모리 격리 관점에서는 프로세스가 유리

###### 동시에 여러 작업을 처리해야 하는가 ?
동시에 여러 작업을 처리한다는 것은 동시성이 있어야 한다는 얘기인데, 이는 
context switching 이 일어나야 한다는 것을 의미하며, 이때는 context switching overhead 가 적은 스레드가 유리하다.

실제로는 멀티코어 환경에서 스레드가 더 큰 이점을 갖는다.
-> why ?
싱글 코어에서는 한번에 하나의 스레드만 실행이 된다.
하지만 멀티코어에서는 두 개 이상의 스레드가 동시에 실행되기 때문에 전체 처리하는 스레드의 속도는 늘어난다.

###### 오류가 한 작업에만 영향을 미치게 하고 싶은가 ?

스레드는 다른 스레드와 공유하는 부분이 많기 때문에 스레드 하나의 행동이 같은 프로세스 
내에 있는 다른 스레드에 영향을 많이 준다. 
만약 오류가 한작업에만 영향을 미치게 하고 싶다면, 별도의 메모리 공간을 사용하는 프로세스가 유리하다.

###### 성능 (오버헤드, 속도) 이 중요한가 ?

실행 하는데 필요한 메모리 양이 상대적으로 적고 
context switching 의 오버헤드가 낮은 스레드가 유리하다.
대신 스레드는 동기화를 위한 자원이 프로세스보다 크게 필요하다는 점이 있다.

###### 공유 자원 (데이터, 파일) 을 쉽게 다뤄야 하는가 ?

스레드는 같은 프로세스 내에서 메모리, 데이터, 파일 핸들 등을 아주 쉽게 공유할 수 있다.
따라서 동기화가 필요하지만 말이다.
프로세스는 기본적으로 메모리를 공유하지 않기 때문에, 공유를 위해 더 복잡한 IPC 가 필요하다.

따라서 쉽게 다루어야 한다면 스레드가 유리하다.


#### 메모리와 실행 관점

- 프로세스 A와 B가 동시에 실행될 때, 한쪽이 변수 값을 바꾸면 다른 쪽에 영향을 줄까? 스레드라면?

	
- 왜 멀티 프로세스 프로그램은 IPC(파이프, 소켓)가 필요한데, 멀티 스레드는 그냥 변수만 공유하면 될까?

	
- "메모리 공유가 안된다"는 게 정확히 heap, stack, data 영역 중 어디를 말하는 걸까?
    

#### 병렬성과 동시성

- 병렬성(Parallelism)과 동시성(Concurrency)의 정의 차이가 뭘까? (힌트: CPU 코어 개수와 관련)


- 프로세스와 스레드 중 어느 것이 진짜 병렬 실행에 더 유리할까? 왜?


- 싱글 코어 CPU에서도 멀티 스레드가 의미 있을까?
    

#### 락과 동기화

- 왜 멀티 프로세스는 락이 별로 필요 없는데 멀티 스레드는 락이 필수일까?

	
- Race Condition이 왜 스레드에서만 심각한 문제가 될까?

	
- 프로세스 간 데이터 교환은 왜 "안전"하고, 스레드 간 공유는 왜 "위험"할까?



#### 구현 차이

- "구현이 바뀐다"는 게 구체적으로 무슨 뜻일까? (힌트: 코드 작성 방식, 동기화 방법, 에러 처리)

	
- 같은 기능을 멀티 프로세스로 구현할 때와 멀티 스레드로 구현할 때, 코드의 복잡도가 어떻게 다를까?

	
- 한 스레드가 크래시 나면 프로세스 전체에 어떤 영향이 있을까? 한 프로세스가 크래시 나면?
    





> 쓰레드를 직접 생성하는 것과 쓰레드 풀을 사용하는 것 중 성능 차이는 무엇인가?


### Thread Pool 



### Connection Pool



### Object Pool




